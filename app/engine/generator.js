/**
 * FERIXDI Studio ‚Äî Generator v2
 * Production Contract: Veo 3.1 ‚Ä¢ 8s ‚Ä¢ Handheld Selfie Feel
 * Universal character adapter ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ª—é–±–æ–π –ø–∞—Ä–æ–π –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
 */

import { estimateDialogue } from './estimator.js';
import { runAllValidations, scanBannedWords } from './validators.js';
import { autoTrim } from './auto_trim.js';
import { historyCache } from './history_cache.js';

// ‚îÄ‚îÄ‚îÄ V2 TIMING GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GRID_V2 = {
  hook:    { start: 0.0, end: 0.8 },
  act_A:   { start: 0.8, end: 3.6 },
  act_B:   { start: 3.6, end: 7.1 },
  release: { start: 7.1, end: 8.0 },
};

// ‚îÄ‚îÄ‚îÄ LOCATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LOCATIONS = [
  'Weathered wooden barn interior, hay bales, single dusty lightbulb swinging, cracks of sunlight through planks',
  'Old bathhouse interior, fogged mirrors, wooden benches, copper ladle, steam wisps in backlight',
  'Root cellar with earthen walls, shelves of preserves in glass jars, bare bulb overhead, cool blue-tint air',
  'Chicken coop doorway, feathers floating in golden backlight, wooden perch, scratching hens out of focus',
  'Overgrown garden path, sunflowers towering overhead, rusty watering can, dappled light through foliage',
  'Dusty attic with exposed rafters, cardboard boxes, moth-eaten curtains, slanted skylight beam',
  'Soviet-era kitchen, peeling wallpaper, humming Saratov fridge, net curtains filtering amber sunlight',
  'Concrete balcony with drying laundry, distant city haze, rusted railing with chipped turquoise paint',
  'Dacha greenhouse with fogged glass panels, tomato vines, soil-stained wooden shelves',
  'Stairwell landing with beige tile, fluorescent tube buzzing overhead, mailboxes, elevator door ajar',
  'Open-air bazaar stall, pyramid of watermelons, striped awning, plastic bags rustling in breeze',
  'Polyclinic corridor, mint-green walls, wooden bench, numbered doors, faded health poster',
  'Marshrutka interior, vinyl seats, steamed windows, hanging air freshener, driver mirror reflection',
  'Garage interior, oil-stained concrete, tool pegboard, half-disassembled Moskvitch, bare bulb',
  'Park bench near pond with pigeons, birch trees, distant accordion music, golden hour light',
];

// ‚îÄ‚îÄ‚îÄ HOOK ACTIONS v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOOK_ACTIONS = [
  { action_en: 'sharp finger jab at lens, near-miss touch', action_ru: '–ü–∞–ª–µ—Ü –≤ –∫–∞–º–µ—Ä—É, –ø–æ—á—Ç–∏ –∫–∞—Å–∞—è—Å—å –ª–∏–Ω–∑—ã', audio: 'mechanical trigger + sharp inhale' },
  { action_en: 'object tap on glass ‚Äî knuckle rap on invisible screen', action_ru: '–°—Ç—É–∫ –∫–æ—Å—Ç—è—à–∫–∞–º–∏ –ø–æ "—Å—Ç–µ–∫–ª—É"', audio: 'knocking + surprised gasp' },
  { action_en: 'abrupt lean-in to camera, face filling frame', action_ru: '–†–µ–∑–∫–∏–π –Ω–∞–∫–ª–æ–Ω –∫ –∫–∞–º–µ—Ä–µ, –ª–∏—Ü–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–∞–¥—Ä', audio: 'cloth rustle + tense exhale' },
  { action_en: 'slap on table surface, objects rattle', action_ru: '–£–¥–∞—Ä –ø–æ —Å—Ç–æ–ª—É, –ø—Ä–µ–¥–º–µ—Ç—ã –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞—é—Ç', audio: 'table slap + glass rattle' },
  { action_en: 'dramatic removal of glasses/hat as reveal', action_ru: '–î—Ä–∞–º–∞—Ç–∏—á–Ω–æ–µ —Å–Ω—è—Ç–∏–µ –æ—á–∫–æ–≤/—à–∞–ø–∫–∏', audio: 'fabric whoosh + stare-down silence' },
];

// ‚îÄ‚îÄ‚îÄ RELEASE ACTIONS v2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RELEASE_ACTIONS = [
  { action_en: 'shared raspy wheeze-laugh, camera shakes from body tremor', action_ru: '–û–±—â–∏–π —Ö—Ä–∏–ø–ª—ã–π —Å–º–µ—Ö, –∫–∞–º–µ—Ä–∞ —Ç—Ä—è—Å—ë—Ç—Å—è –æ—Ç —Ç—Ä—è—Å–∫–∏ —Ç–µ–ª–∞', audio: 'overlapping wheeze-laughs, gasping inhales, camera mic rumble from hand shake' },
  { action_en: 'A slaps own knee, B doubles over, tears forming', action_ru: 'A —Ö–ª–æ–ø–∞–µ—Ç –ø–æ –∫–æ–ª–µ–Ω—É, B —Å–≥–∏–±–∞–µ—Ç—Å—è –ø–æ–ø–æ–ª–∞–º, —Å–ª—ë–∑—ã', audio: 'knee slap impact, strained laughing exhale, sniffling tears' },
  { action_en: 'both lean into each other laughing, brief embrace', action_ru: '–û–±–∞ –∑–∞–≤–∞–ª–∏–≤–∞—é—Ç—Å—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ –æ—Ç —Å–º–µ—Ö–∞', audio: 'fabric collision rustle, dual belly-laugh, affectionate shoulder pat' },
  { action_en: 'A covers mouth suppressing laugh, B slow triumphant grin', action_ru: 'A –∑–∞–∂–∏–º–∞–µ—Ç —Ä–æ—Ç, B –º–µ–¥–ª–µ–Ω–Ω–∞—è –ø–æ–±–µ–¥–Ω–∞—è —É—Ö–º—ã–ª–∫–∞', audio: 'muffled snort through fingers, quiet satisfied chuckle, nose exhale' },
  { action_en: 'synchronized head-throw-back cackle, camera jolts', action_ru: '–°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ö–æ—Ö–æ—Ç —Å –∑–∞–ø—Ä–æ–∫–∏–Ω—É—Ç–æ–π –≥–æ–ª–æ–≤–æ–π', audio: 'explosive dual cackle, chair creak from lean-back, camera mic peak (near-clip)' },
];

// ‚îÄ‚îÄ‚îÄ SERIAL PROP ANCHORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROP_ANCHORS = [
  'old brass samovar with tarnished patina and wooden handles',
  'dented aluminum bucket with water condensation',
  'cast-iron poker leaning against brick surface',
  'cracked enamel kettle with chipped blue-white pattern',
  'wobbly three-legged wooden stool with worn seat',
  'vintage Rigonda radio with bakelite knobs',
  'wall-mounted rotary phone with coiled cord',
  'heavy glass ashtray with Soviet-era etching',
  'rusted tin watering can with bent spout',
  'dog-eared wall calendar from previous year',
  'ceramic sugar bowl with missing lid, spoon inside',
  'folded newspaper with visible Cyrillic headline',
];

// ‚îÄ‚îÄ‚îÄ CATEGORY ‚Üí LOCATION PREFERENCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Maps category to preferred location indices (from LOCATIONS array)
// Fallback: random from all locations
const LOCATION_HINTS = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': [6, 7, 2],       // Soviet kitchen, balcony, root cellar
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': [6, 9, 7],       // Soviet kitchen, stairwell, balcony
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': [10, 6, 9],      // bazaar, Soviet kitchen, stairwell
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': [6, 14, 7],            // kitchen, park bench, balcony
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': [6, 5, 7],      // kitchen, attic, balcony
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': [9, 7, 6],      // stairwell, balcony, kitchen
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': [11, 9, 6], // polyclinic, stairwell, kitchen
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': [7, 6, 14],     // balcony, kitchen, park
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': [8, 4, 0],         // greenhouse, garden, barn
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': [12, 9, 14],  // marshrutka, stairwell, park
};

// ‚îÄ‚îÄ‚îÄ CATEGORY ‚Üí PROP PREFERENCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROP_HINTS = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': ['cracked enamel kettle with chipped blue-white pattern', 'ceramic sugar bowl with missing lid, spoon inside'],
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': ['vintage Rigonda radio with bakelite knobs', 'wall-mounted rotary phone with coiled cord'],
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': ['folded newspaper with visible Cyrillic headline', 'ceramic sugar bowl with missing lid, spoon inside'],
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': ['heavy glass ashtray with Soviet-era etching', 'wall-mounted rotary phone with coiled cord'],
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': ['vintage Rigonda radio with bakelite knobs', 'dog-eared wall calendar from previous year'],
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': ['cracked enamel kettle with chipped blue-white pattern', 'old brass samovar with tarnished patina and wooden handles'],
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': ['dog-eared wall calendar from previous year', 'folded newspaper with visible Cyrillic headline'],
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': ['heavy glass ashtray with Soviet-era etching', 'folded newspaper with visible Cyrillic headline'],
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': ['rusted tin watering can with bent spout', 'dented aluminum bucket with water condensation'],
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': ['folded newspaper with visible Cyrillic headline', 'heavy glass ashtray with Soviet-era etching'],
};

// ‚îÄ‚îÄ‚îÄ LIGHTING VARIATIONS BY LOCATION TYPE ‚îÄ‚îÄ‚îÄ
const LIGHTING_MOODS = [
  { style: 'warm amber backlight through dusty window, hard shadows, 3200K, golden dust motes in light beams', mood: 'nostalgic warmth' },
  { style: 'cool fluorescent overhead with greenish tint, flat institutional light, subtle flicker', mood: 'sterile tension' },
  { style: 'dappled natural light through foliage, shifting leaf shadows on faces, warm-cool contrast', mood: 'organic chaos' },
  { style: 'single bare bulb overhead, harsh directional light from above, deep eye-socket shadows', mood: 'dramatic intimacy' },
  { style: 'overcast diffused daylight from large window, soft shadowless fill, slight blue undertone', mood: 'calm before storm' },
];

const HUMOR_CATEGORIES = [
  { ru: '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥', en: 'Domestic absurdity' },
  { ru: 'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', en: 'AI and technology' },
  { ru: '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è', en: 'Prices and inflation' },
  { ru: '–û—Ç–Ω–æ—à–µ–Ω–∏—è', en: 'Relationships' },
  { ru: '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π', en: 'Generation gap' },
  { ru: '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞', en: 'Housing utilities drama' },
  { ru: '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞', en: 'Health and polyclinic' },
  { ru: '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã', en: 'Social media trends' },
  { ru: '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥', en: 'Dacha and gardening' },
  { ru: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏', en: 'Transport and traffic' },
];

// ‚îÄ‚îÄ‚îÄ HASHTAG ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Instagram strategy 2026: 3-5 –±–æ–ª—å—à–∏—Ö (>1M), 5-8 —Å—Ä–µ–¥–Ω–∏—Ö (100K-1M), 5-7 –º–∞–ª–µ–Ω—å–∫–∏—Ö (<100K)
// –ù–∏–∫–∞–∫–æ–≥–æ —Å–ø–∞–º–∞ —Ç–∏–ø–∞ #funny #comedy #viral ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –¥–∞—É–Ω—Ä–µ–π—Ç–∏—Ç
// –í—Å–µ —Ç–µ–≥–∏ –†–ï–õ–ï–í–ê–ù–¢–ù–´ –∫–æ–Ω—Ç–µ–Ω—Ç—É

const HASHTAGS_BY_CATEGORY = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': {
    niche: ['#–±—ã—Ç–æ–≤–∞—è–¥—Ä–∞–º–∞', '#–∂–∏–∑–∞–∂–µ—Å—Ç—å', '#–∞–±—Å—É—Ä–¥—Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏', '#—ç—Ç–æ–Ω–æ—Ä–º–∞–ª—å–Ω–æ', '#–±—ã—Ç–æ–≤—É—Ö–∞', '#–∫—É—Ö–æ–Ω–Ω—ã–µ–≤–æ–π–Ω—ã'],
    mid:   ['#–∂–∏–∑–∞', '#—Ä–∂—É–Ω–µ–º–æ–≥—É', '#—Å–º–µ—à–Ω–æ–¥–æ—Å–ª—ë–∑', '#–∂–∏–∑–Ω–µ–Ω–Ω–æ', '#–ø—Ä–∞–≤–¥–∞–∂–∏–∑–Ω–∏'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#—Ä—É—Å—Å–∫–∏–π—é–º–æ—Ä'],
  },
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': {
    niche: ['#–Ω–µ–π—Ä–æ—Å–µ—Ç—å–ø—Ä–æ—Ç–∏–≤–±–∞–±–∫–∏', '#–∏–∏vs—á–µ–ª–æ–≤–µ–∫', '#—Ä–æ–±–æ—Ç—ã–∑–∞–º–µ–Ω—è—Ç', '#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏–±—É–¥—É—â–µ–≥–æ', '#chatgpt–ø–æ—Ä—É—Å—Å–∫–∏', '#–Ω–µ–π—Ä–æ—Å–µ—Ç–∏–ø—Ä–∏–∫–æ–ª—ã'],
    mid:   ['#–∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π–∏–Ω—Ç–µ–ª–ª–µ–∫—Ç', '#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', '#–±—É–¥—É—â–µ–µ–Ω–∞—Å—Ç—É–ø–∏–ª–æ', '#–Ω–µ–π—Ä–æ—Å–µ—Ç—å', '#aihumor'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏2026'],
  },
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': {
    niche: ['#—Ü–µ–Ω—ã–æ—Ö—Ä–µ–Ω–µ–ª–∏', '#–∏–Ω—Ñ–ª—è—Ü–∏—è–¥–Ω—è', '#–¥–æ—Ä–æ–∂–µ–≤—Å—ë', '#–ø—Ä–æ–¥—É–∫—Ç—ã–ø–æ–¥–æ—Ä–æ–∂–∞–ª–∏', '#—Ü–µ–Ω–Ω–∏–∫2026', '#—ç–∫–æ–Ω–æ–º–∏–º–≤–º–µ—Å—Ç–µ'],
    mid:   ['#—Ü–µ–Ω—ã', '#–∏–Ω—Ñ–ª—è—Ü–∏—è', '#–¥–æ—Ä–æ–≥–æ', '#–º–∞–≥–∞–∑–∏–Ω', '#–ø—Ä–æ–¥—É–∫—Ç—ã'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–∂–∏–∑–∞'],
  },
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': {
    niche: ['#–º—É–∂–∏–∫–∏—Ç–∞–∫–∏–µ', '#–∂–µ–Ω—â–∏–Ω—ã—Ç–∞–∫–∏–µ', '#–æ—Ç–Ω–æ—à–µ–Ω–∏—è—ç—Ç–æ', '#–ø–∞—Ä–æ—á–∫–∏', '#–ª—é–±–æ–≤—å–ø–æ—Ä—É—Å—Å–∫–∏', '#—Å–≤–∏–¥–∞–Ω–∏–µ–ø—Ä–∏–∫–æ–ª—ã'],
    mid:   ['#–æ—Ç–Ω–æ—à–µ–Ω–∏—è', '#–ª—é–±–æ–≤—å', '#–ø–∞—Ä–µ–Ω—å', '#—Å–µ–º—å—è', '#–º—É–∂'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–ø—Ä–∞–≤–¥–∞–∂–∏–∑–Ω–∏'],
  },
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': {
    niche: ['#–ø–æ–∫–æ–ª–µ–Ω–∏–µ–∑—É–º–µ—Ä–æ–≤', '#–æ–∫–µ–π–±—É–º–µ—Ä', '#–±–∞–±–∫–∞vs–≤–Ω—É—á–∫–∞', '#–º–æ–ª–æ–¥—ë–∂—å—Ç–∞–∫–∞—è', '#—Å—Ç–∞—Ä—à–µ–µ–ø–æ–∫–æ–ª–µ–Ω–∏–µ', '#–∫–æ–Ω—Ñ–ª–∏–∫—Ç–ø–æ–∫–æ–ª–µ–Ω–∏–π'],
    mid:   ['#–ø–æ–∫–æ–ª–µ–Ω–∏—è', '#–º–æ–ª–æ–¥—ë–∂—å', '#–±–∞–±—É—à–∫–∞', '#–≤–Ω—É–∫–∏', '#–∑—É–º–µ—Ä—ã'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–∂–∏–∑–Ω–µ–Ω–Ω–æ'],
  },
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': {
    niche: ['#–∂–∫—Ö–ø—Ä–∏–∫–æ–ª—ã', '#–∫–æ–º–º—É–Ω–∞–ª–∫–∞–≥–æ—Ä–∏—Ç', '#—É–ø—Ä–∞–≤–ª—è—é—â–∞—è–∫–æ–º–ø–∞–Ω–∏—è', '#–∫–≤–∏—Ç–∞–Ω—Ü–∏—è–∫–æ—Å–º–æ—Å', '#–æ—Ç–æ–ø–ª–µ–Ω–∏–µ–≤–∫–ª—é—á–∏–ª–∏', '#—Å–æ—Å–µ–¥–∏—Å–Ω–∏–∑—É'],
    mid:   ['#–∂–∫—Ö', '#–∫–æ–º–º—É–Ω–∞–ª–∫–∞', '#–∫–≤–∞—Ä—Ç–∏—Ä–∞', '#—Å–æ—Å–µ–¥–∏', '#—Å—á—ë—Ç–∑–∞–∫–æ–º–º—É–Ω–∞–ª–∫—É'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–∂–∏–∑–∞'],
  },
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': {
    niche: ['#–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞–ø—Ä–∏–∫–æ–ª—ã', '#–æ—á–µ—Ä–µ–¥—å–∫–≤–≤—Ä–∞—á—É', '#–¥–æ–∫—Ç–æ—Ä—Å–∫–∞–∑–∞–ª', '#–º–µ–¥–∏—Ü–∏–Ω–∞–ø–æ—Ä—É—Å—Å–∫–∏', '#—Ä–µ—Ü–µ–ø—Ç–æ—Ç–±–∞–±–∫–∏', '#–∑–¥–æ—Ä–æ–≤—å–µ–Ω–µ–∫—É–ø–∏—à—å'],
    mid:   ['#–ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞', '#–≤—Ä–∞—á', '#–∑–¥–æ—Ä–æ–≤—å–µ', '#–º–µ–¥–∏—Ü–∏–Ω–∞', '#–±–æ–ª—å–Ω–∏—Ü–∞'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–ø—Ä–∞–≤–¥–∞–∂–∏–∑–Ω–∏'],
  },
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': {
    niche: ['#–±–ª–æ–≥–µ—Ä—ã–ø—Ä–∏–∫–æ–ª—ã', '#—Ç–∏–∫—Ç–æ–∫–µ—Ä—ã', '#–ø–æ–¥–ø–∏—Å—á–∏–∫–∏', '#–∫–æ–Ω—Ç–µ–Ω—Ç–º–µ–π–∫–µ—Ä', '#—Ö–∞–π–ø–¥–Ω—è', '#—Ä–∏–ª—Å–º–µ–π–∫–µ—Ä'],
    mid:   ['#—Å–æ—Ü—Å–µ—Ç–∏', '#–±–ª–æ–≥–µ—Ä', '#—Ç—Ä–µ–Ω–¥—ã', '#–∏–Ω—Å—Ç–∞–≥—Ä–∞–º', '#–∫–æ–Ω—Ç–µ–Ω—Ç'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#—Ç—Ä–µ–Ω–¥—ã2026'],
  },
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': {
    niche: ['#–¥–∞—á–∞–ø—Ä–∏–∫–æ–ª—ã', '#–æ–≥–æ—Ä–æ–¥–Ω–∏–∫–∞–º', '#–ø–æ–º–∏–¥–æ—Ä–Ω–∞—è–¥—Ä–∞–º–∞', '#—Å–æ—Å–µ–¥–ø–æ–¥–∞—á–µ', '#—É—Ä–æ–∂–∞–π2026', '#–≥—Ä—è–¥–∫–∏–≤–æ–π–Ω—ã'],
    mid:   ['#–¥–∞—á–∞', '#–æ–≥–æ—Ä–æ–¥', '#—É—Ä–æ–∂–∞–π', '#—Å–∞–¥', '#–¥–∞—á–Ω–∞—è–∂–∏–∑–Ω—å'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–ª–µ—Ç–æ'],
  },
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': {
    niche: ['#–ø—Ä–æ–±–∫–∏–º–æ—Å–∫–≤—ã', '#–º–∞—Ä—à—Ä—É—Ç–∫–∞–ø—Ä–∏–∫–æ–ª—ã', '#—Å–∞–º–æ–∫–∞—Ç–≤—Å–≥–æ—Ä–æ–¥', '#–≤–æ–¥–∏—Ç–µ–ª–∏–ø—Ä–∏–∫–æ–ª—ã', '#–æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '#–ø–∞—Ä–∫–æ–≤–∫–∞–¥—Ä–∞–º–∞'],
    mid:   ['#–ø—Ä–æ–±–∫–∏', '#—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç', '#–º–µ—Ç—Ä–æ', '#—Å–∞–º–æ–∫–∞—Ç', '#–≤–æ–¥–∏—Ç–µ–ª—å'],
    big:   ['#—é–º–æ—Ä–¥–Ω—è', '#—Ä–∏–ª—Å', '#–º–æ—Å–∫–≤–∞'],
  },
};

// Evergreen —Ç–µ–≥–∏ ‚Äî –ø–æ–¥–º–µ—à–∏–≤–∞—é—Ç—Å—è –≤—Å–µ–≥–¥–∞ (2-3 —à—Ç)
const EVERGREEN_TAGS = [
  '#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏', '#–ø–æ–ø–∞–ª–≤—Ä–µ–∫–∏', '#–∑–∞–ª–µ—Ç–µ–≤—Ä–µ–∫–∏',
  '#shorts', '#reels', '#—Ä–∏–ª—Å—ã',
  '#—Å–º–µ—à–Ω–æ–µ–≤–∏–¥–µ–æ', '#–ø—Ä–∏–∫–æ–ª—ã2026', '#—é–º–æ—Ä',
];

// –ü–µ—Ä—Å–æ–Ω–∞–∂–Ω—ã–µ —Ç–µ–≥–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º
const GROUP_HASHTAGS = {
  '–±–∞–±–∫–∏':      ['#–±–∞–±–∫–∞–∂–∂—ë—Ç', '#–±–∞–±—É—à–∫–∞—Å–∫–∞–∑–∞–ª–∞', '#–±–∞–±–∫–∏–æ–≥–æ–Ω—å', '#—Å—Ç–∞—Ä—à–µ–µ–ø–æ–∫–æ–ª–µ–Ω–∏–µ'],
  '–¥–µ–¥—ã':       ['#–¥–µ–¥—Å–∫–∞–∑–∞–ª', '#–¥–µ–¥–º—É–¥—Ä–æ—Å—Ç—å', '#—Å—Ç–∞—Ä—ã–π–¥–∞—Ä—É—Å—Å–∫–∏–π', '#–¥–µ–¥–æ–≤—Å–∫–∏–π—é–º–æ—Ä'],
  '–º–∞–º—ã':       ['#–º–∞–º–∞—Å–∫–∞–∑–∞–ª–∞', '#–º–∞–º–∞–ø—Ä–∞–≤–∞', '#–º–∞—Ç–µ—Ä–∏–Ω—Å–∫–∏–π–∏–Ω—Å—Ç–∏–Ω–∫—Ç', '#–º–∞–º—ã–ø–æ–π–º—É—Ç'],
  '–ø–∞–ø—ã':       ['#–ø–∞–ø–∞—Å–∫–∞–∑–∞–ª', '#–ø–∞–ø–∞—à—É—Ç–∏—Ç', '#–æ—Ç–µ—Ü–º–æ–ª–æ–¥–µ—Ü', '#–ø–∞–ø–∏–Ω—ã–ø—Ä–∏–∫–æ–ª—ã'],
  '–¥–æ—á–µ—Ä–∏':     ['#–¥–æ—á–∫–∞—Ç–∞–∫–∞—è', '#–¥–æ—á—åvsmama', '#–º–æ–ª–æ–¥—ë–∂—å', '#–ø–æ–∫–æ–ª–µ–Ω–∏–µ–∞–ª—å—Ñ–∞'],
  '—Å—ã–Ω–æ–≤—å—è':    ['#—Å—ã–Ω—Ç–∞–∫–æ–π', '#—Å—ã–Ωvs–æ—Ç–µ—Ü', '#–ø–∞—Ü–∞–Ω—ã', '#—Å—ã–Ω–æ–∫'],
  '—Ç—ë—â–∏':       ['#—Ç—ë—â–∞–æ–≥–æ–Ω—å', '#—Ç—ë—â–∞—Å–∫–∞–∑–∞–ª–∞', '#–∑—è—Ç—å–≤—à–æ–∫–µ', '#—Ç—ë—â–∞vs–∑—è—Ç—å'],
  '—Å–≤–µ–∫—Ä–æ–≤–∏':   ['#—Å–≤–µ–∫—Ä–æ–≤—å', '#—Å–≤–µ–∫—Ä–æ–≤—å—Å–∫–∞–∑–∞–ª–∞', '#–Ω–µ–≤–µ—Å—Ç–∫–∞–≤—à–æ–∫–µ', '#—Å–µ–º–µ–π–Ω—ã–µ–¥—Ä–∞–º—ã'],
  '—Å–æ—Å–µ–¥–∏':     ['#—Å–æ—Å–µ–¥–∏–ø—Ä–∏–∫–æ–ª—ã', '#—Å–æ—Å–µ–¥—Ç–∞–∫–æ–π', '#–ø–æ–¥—ä–µ–∑–¥–Ω–∞—è–¥—Ä–∞–º–∞', '#—Å–æ—Å–µ–¥–∏—Å–∫–∞–Ω–¥–∞–ª'],
  '–ø—Ä–æ–¥–∞–≤—Ü—ã':   ['#–ø—Ä–æ–¥–∞–≤—â–∏—Ü–∞', '#–º–∞–≥–∞–∑–∏–Ω–ø—Ä–∏–∫–æ–ª—ã', '#–Ω–∞–∫–∞—Å—Å–µ', '#–ø–æ–∫—É–ø–∞—Ç–µ–ª—å–≤—à–æ–∫–µ'],
  '–≤—Ä–∞—á–∏':      ['#–¥–æ–∫—Ç–æ—Ä–ø—Ä–∏–∫–æ–ª—ã', '#–≤—Ä–∞—á—Å–∫–∞–∑–∞–ª', '#–º–µ–¥–∏–∫–∏—à—É—Ç—è—Ç', '#–¥–∏–∞–≥–Ω–æ–∑—é–º–æ—Ä'],
  '—É—á–∏—Ç–µ–ª—è':    ['#—É—á–∏—Ç–µ–ª—å–Ω–∏—Ü–∞', '#—à–∫–æ–ª–∞–ø—Ä–∏–∫–æ–ª—ã', '#—É—á–∏—Ç–µ–ª—å', '#—É—Ä–æ–∫–∂–∏–∑–Ω–∏'],
  '–±–ª–æ–≥–µ—Ä—ã':    ['#–±–ª–æ–≥–µ—Ä—à–∞', '#–∏–Ω—Å—Ç–∞–±–ª–æ–≥–µ—Ä', '#–±–ª–æ–≥–µ—Ä—ã–ø—Ä–∏–∫–æ–ª—ã', '#–∫–æ–Ω—Ç–µ–Ω—Ç–º–µ–π–∫–µ—Ä'],
  '—Ç–∞–∫—Å–∏—Å—Ç—ã':   ['#—Ç–∞–∫—Å–∏—Å—Ç', '#—è–Ω–¥–µ–∫—Å—Ç–∞–∫—Å–∏', '#–≤–æ–¥–∏—Ç–µ–ª—å—Ç–∞–∫—Å–∏', '#–ø–æ–µ–∑–¥–∫–∞–ø—Ä–∏–∫–æ–ª—ã'],
  '–±–∏–∑–Ω–µ—Å–º–µ–Ω—ã': ['#–±–∏–∑–Ω–µ—Å–º–µ–Ω', '#–±–∏–∑–Ω–µ—Å–ø—Ä–∏–∫–æ–ª—ã', '#–ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å', '#—Å—Ç–∞—Ä—Ç–∞–ø'],
  '—Å—Ç—É–¥–µ–Ω—Ç—ã':   ['#—Å—Ç—É–¥–µ–Ω—Ç', '#—É–Ω–∏–≤–µ—Ä', '#—Å–µ—Å—Å–∏—è', '#—Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–π—é–º–æ—Ä'],
  '–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã': ['#–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä', '#–ø–µ–Ω—Å–∏—è', '#–ø–µ–Ω—Å–∏–æ–Ω–µ—Ä—ã–∂–≥—É—Ç', '#—Å—Ç–∞—Ä—à–µ–µ–ø–æ–∫–æ–ª–µ–Ω–∏–µ'],
  '—á–∏–Ω–æ–≤–Ω–∏–∫–∏':  ['#—á–∏–Ω–æ–≤–Ω–∏–∫–∏', '#–±—é—Ä–æ–∫—Ä–∞—Ç–∏—è', '#–≥–æ—Å—É—Å–ª—É–≥–∏', '#–º—Ñ—Ü'],
  '—Ñ–∏—Ç–Ω–µ—Å':     ['#—Ñ–∏—Ç–Ω–µ—Å—é–º–æ—Ä', '#–∑–æ–∂', '#—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞', '#—Ñ–∏—Ç–Ω–µ—Å—Ç—Ä–µ–Ω–µ—Ä'],
  '–∫–æ—à–∞—Ç–Ω–∏—Ü—ã':  ['#–∫–æ—à–∞—Ç–Ω–∏—Ü–∞', '#–∫–æ—Ç–∏–∫–∏', '#–∫–æ—à–∫–∏–ø—Ä–∞–≤—è—Ç', '#–∫–æ—Ç–æ–º–∞–º–∞'],
  '—ç–∫—Å—Ç—Ä–µ–º–∞–ª—ã': ['#—ç–∫—Å—Ç—Ä–∏–º', '#–∞–¥—Ä–µ–Ω–∞–ª–∏–Ω', '#—ç–∫—Å—Ç—Ä–µ–º–∞–ª', '#–±–µ–∑–±–∞—à–µ–Ω–Ω—ã–π'],
};

// ‚îÄ‚îÄ‚îÄ VIRAL TITLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Hook-—Ñ–æ—Ä–º—É–ª—ã: –≤–æ–ø—Ä–æ—Å / —à–æ–∫ / –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ—Å—Ç—å / –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è
const VIRAL_TITLES = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': [
    '–û–Ω–∞ —Ä–µ–∞–ª—å–Ω–æ —ç—Ç–æ —Å–∫–∞–∑–∞–ª–∞ –ø—Ä–∏ –≤—Å–µ—Ö...',
    '–ö–æ–≥–¥–∞ {A} —É–∑–Ω–∞–ª–∞ –ø—Ä–∞–≤–¥—É ‚Äî –ª–∏—Ü–æ –±–µ—Å—Ü–µ–Ω–Ω–æ üíÄ',
    '–í–æ—Ç –ø–æ—ç—Ç–æ–º—É —Å {A} –ª—É—á—à–µ –Ω–µ —Å–ø–æ—Ä–∏—Ç—å',
    '{A} vs –∑–¥—Ä–∞–≤—ã–π —Å–º—ã—Å–ª: 0-1 ü§£',
    '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ª–æ–≤–∞ {B} —É–±–∏–ª–∏ –Ω–∞–ø–æ–≤–∞–ª',
  ],
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': [
    '{A} –≤–ø–µ—Ä–≤—ã–µ —É–∑–Ω–∞–ª–∞ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏... –∏ –ø–æ–Ω–µ—Å–ª–æ—Å—å üíÄ',
    '–ö–æ–≥–¥–∞ {B} –æ–±—ä—è—Å–Ω–∏–ª —á—Ç–æ —Ç–∞–∫–æ–µ AI –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏',
    '–†–µ–∞–∫—Ü–∏—è {A} –Ω–∞ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç ‚Äî –ë–ï–°–¶–ï–ù–ù–û',
    '{B} –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π —É–Ω–∏—á—Ç–æ–∂–∏–ª –≤–µ—Å—å —Ç–µ—Ö–Ω–æ–ø—Ä–æ–≥—Ä–µ—Å—Å',
    '–ü–æ–∫–∞–∂–∏ —ç—Ç–æ —Ç–æ–º—É –∫—Ç–æ –±–æ–∏—Ç—Å—è —á—Ç–æ —Ä–æ–±–æ—Ç—ã –∑–∞–º–µ–Ω—è—Ç –ª—é–¥–µ–π',
  ],
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': [
    '{A} –∑–∞—à–ª–∞ –≤ –º–∞–≥–∞–∑–∏–Ω –∏ –∞—Ö–Ω—É–ª–∞... üò±',
    '–ö–æ–≥–¥–∞ {B} –≤—Å–ø–æ–º–Ω–∏–ª —Ü–µ–Ω—ã –∏–∑ 90-—Ö ‚Äî {A} –≤ —à–æ–∫–µ',
    '–¶–µ–Ω—ã 2026: {A} –Ω–µ –º–æ–∂–µ—Ç –ø–æ–≤–µ—Ä–∏—Ç—å',
    '–û–¥–Ω–∞ —Ñ—Ä–∞–∑–∞ {B} –ø—Ä–æ —Ü–µ–Ω—ã –∑–∞—Å—Ç–∞–≤–∏—Ç —Ç–µ–±—è –ø–ª–∞–∫–∞—Ç—å –∏ —Å–º–µ—è—Ç—å—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ',
    '–í–æ—Ç –ø–æ—á–µ–º—É {A} –±–æ–ª—å—à–µ –Ω–µ —Ö–æ–¥–∏—Ç –≤ –º–∞–≥–∞–∑–∏–Ω',
  ],
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': [
    '–ö–æ–≥–¥–∞ {A} –ø–æ–∫–∞–∑–∞–ª–∞ –ø–µ—Ä–µ–ø–∏—Å–∫—É ‚Äî {B} –≤—Å—ë –æ–±—ä—è—Å–Ω–∏–ª –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π üíÄ',
    '{B} —Ä–∞—Å—Å–∫–∞–∑–∞–ª –∫–∞–∫ —Ä–∞–Ω—å—à–µ —É—Ö–∞–∂–∏–≤–∞–ª–∏ ‚Äî –¥–µ–≤–æ—á–∫–∏, –≤—ã –Ω–µ –≥–æ—Ç–æ–≤—ã',
    '–ò–¥–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç {B} –Ω–∞ –∂–∞–ª–æ–±—ã –ø—Ä–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º—É–∂–∏–∫–æ–≤',
    '{A} –æ–ø–∏—Å–∞–ª–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è ‚Äî {B} –≤ –∞—É—Ç–µ',
    '–ü–æ–∫–∞–∑–∞–ª –º–∞–º–µ ‚Äî –æ–Ω–∞ –ø–ª–∞–∫–∞–ª–∞ –æ—Ç —Å–º–µ—Ö–∞',
  ],
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': [
    '{A} —É–∑–Ω–∞–ª–∞ —á–µ–º –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –≤–Ω—É—á–∫–∞ ‚Äî —Ä–µ–∞–∫—Ü–∏—è üíÄ',
    '–ö–æ–≥–¥–∞ {B} –æ–±—ä—è—Å–Ω–∏–ª –º–æ–ª–æ–¥—ë–∂—å –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π',
    '{A} vs TikTok: –±–æ–π –≤–µ–∫–∞',
    '–í–æ—Ç —Ç–∞–∫ {B} –≤–∏–¥–∏—Ç –ø–æ–∫–æ–ª–µ–Ω–∏–µ Z',
    '–ü–æ–∫–∞–∂–∏ –±–∞–±—É—à–∫–µ ‚Äî –ø—Ä–æ–≤–µ—Ä—å —Ä–µ–∞–∫—Ü–∏—é ü§£',
  ],
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': [
    '{A} –ø–æ–ª—É—á–∏–ª–∞ –∫–≤–∏—Ç–∞–Ω—Ü–∏—é ‚Äî —Å—è–¥—å—Ç–µ üò±',
    '–û—Ç–≤–µ—Ç {B} –Ω–∞ —Å—á—ë—Ç –∑–∞ –ñ–ö–• ‚Äî –≥–µ–Ω–∏–∞–ª—å–Ω–æ',
    '–í–æ—Ç –ø–æ—á–µ–º—É {A} –≤–æ—é–µ—Ç —Å —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–µ–π',
    '{B} –ø—Ä–æ –∫–æ–º–º—É–Ω–∞–ª–∫—É ‚Äî –±–æ–ª—å–Ω–æ –Ω–æ —Å–º–µ—à–Ω–æ',
    '–°–∫–∏–Ω—å —ç—Ç–æ –≤ —á–∞—Ç –¥–æ–º–∞ ‚Äî —Å–æ—Å–µ–¥–∏ –æ—Ü–µ–Ω—è—Ç',
  ],
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': [
    '{A} –ø–æ—Å–ª–µ –≤–∏–∑–∏—Ç–∞ –∫ –≤—Ä–∞—á—É ‚Äî —è –ø–ª–∞–∫–∞–ª üíÄ',
    '–ö–æ–≥–¥–∞ {B} –ø–æ—Å—Ç–∞–≤–∏–ª –¥–∏–∞–≥–Ω–æ–∑ –ª—É—á—à–µ –¥–æ–∫—Ç–æ—Ä–∞',
    '–†–µ–∞–∫—Ü–∏—è {A} –Ω–∞ —Å–æ–≤–µ—Ç –≤—Ä–∞—á–∞ ‚Äî –ó–û–õ–û–¢–û',
    '{B} –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π –æ–ø–∏—Å–∞–ª –≤—Å—é –º–µ–¥–∏—Ü–∏–Ω—É',
    '–ü–æ–∫–∞–∂–∏ –∑–Ω–∞–∫–æ–º–æ–º—É –≤—Ä–∞—á—É ‚Äî –æ—Ü–µ–Ω–∏—Ç ü§£',
  ],
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': [
    '{A} —É–∑–Ω–∞–ª–∞ —á—Ç–æ —Ç–∞–∫–æ–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ ‚Äî —Ä–µ–∞–∫—Ü–∏—è üíÄ',
    '–ö–æ–≥–¥–∞ {B} –æ–±—ä—è—Å–Ω–∏–ª —Å—É—Ç—å –±–ª–æ–≥–∏–Ω–≥–∞ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π',
    '{A} vs Instagram: –∫—Ç–æ –∫–æ–≥–æ',
    '–û—Ç–≤–µ—Ç {B} –ø—Ä–æ –º–∏–ª–ª–∏–æ–Ω –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ ‚Äî –≥–µ–Ω–∏–∞–ª—å–Ω–æ',
    '–°–∫–∏–Ω—å –±–ª–æ–≥–µ—Ä—É ‚Äî –ø—É—Å—Ç—å –ø—Ä–æ–∑—Ä–µ–µ—Ç ü§£',
  ],
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': [
    '{A} –æ–±–Ω–∞—Ä—É–∂–∏–ª–∞ —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å –ø–æ–º–∏–¥–æ—Ä–∞–º–∏ üò±',
    '–í–µ—Ä—Å–∏—è {B} –∫—Ç–æ —Å–æ–∂—Ä–∞–ª —É—Ä–æ–∂–∞–π ‚Äî —è —Ä—ã–¥–∞–ª',
    '{A} vs –æ–≥–æ—Ä–æ–¥: –≤–µ—á–Ω–∞—è –±–∏—Ç–≤–∞',
    '–ö–æ–≥–¥–∞ {B} –æ–±—ä—è—Å–Ω–∏–ª —Å—É—Ç—å –¥–∞—á–Ω–æ–π –∂–∏–∑–Ω–∏ –æ–¥–Ω–æ–π —Ñ—Ä–∞–∑–æ–π',
    '–°–∫–∏–Ω—å –¥–∞—á–Ω–∏–∫—É ‚Äî —Ç–æ—á–Ω–æ —É–∑–Ω–∞–µ—Ç —Å–µ–±—è ü§£',
  ],
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': [
    '{A} –ø—Ä–æ—Å—Ç–æ—è–ª–∞ –≤ –ø—Ä–æ–±–∫–µ 2 —á–∞—Å–∞ ‚Äî –∏ –≤–æ—Ç —á—Ç–æ —Å–∫–∞–∑–∞–ª–∞ üíÄ',
    '–ö–æ–≥–¥–∞ {B} —Å—Ä–∞–≤–Ω–∏–ª —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ‚Äî {A} –≤ —à–æ–∫–µ',
    '{A} vs –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç: 0-1',
    '–û—Ç–≤–µ—Ç {B} –ø—Ä–æ –ø—Ä–æ–±–∫–∏ –∑–∞—Å—Ç–∞–≤–∏—Ç –ø–ª–∞–∫–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–π',
    '–°–∫–∏–Ω—å —Ç–æ–º—É –∫—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å —Å—Ç–æ–∏—Ç –≤ –ø—Ä–æ–±–∫–µ ü§£',
  ],
};

// ‚îÄ‚îÄ‚îÄ PIN COMMENTS (–ó–ê–ö–†–ï–ü–´) ‚Äî –±–∞–π—Ç –Ω–∞ –ø–µ—Ä–µ—Å—ã–ª–∫—É ‚îÄ‚îÄ
const PIN_COMMENTS = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': [
    '–û—Ç–ø—Ä–∞–≤—å —Ç–æ–º—É, —É –∫–æ–≥–æ –¥–æ–º–∞ —Ç–∞–∫–æ–π –∂–µ —Ü–∏—Ä–∫ üé™üòÇ',
    '–°–∫–∏–Ω—å –º–∞–º–µ ‚Äî –æ–Ω–∞ —Ç–æ—á–Ω–æ —Å–∫–∞–∂–µ—Ç ¬´—ç—Ç–æ –ø—Ä–æ –Ω–∞—Å¬ª üíÄ',
    '–¢–µ–≥ –ø–æ–¥—Ä—É–≥—É —É –∫–æ—Ç–æ—Ä–æ–π —Ç–∞–∫ –∂–µ –¥–æ–º–∞ üëá',
    '–ö—Ç–æ —É–∑–Ω–∞–ª —Å–≤–æ—é —Å–µ–º—å—é ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤ —Å–µ–º–µ–π–Ω—ã–π —á–∞—Ç –∏ –∂–¥–∏ —Ä–µ–∞–∫—Ü–∏—é üì±',
  ],
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': [
    '–û—Ç–ø—Ä–∞–≤—å —Ç–æ–º—É, –∫—Ç–æ –¥–æ —Å–∏—Ö –ø–æ—Ä –±–æ–∏—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π ü§ñüòÇ',
    '–°–∫–∏–Ω—å –±–∞–±—É—à–∫–µ –∏ —Å–Ω–∏–º–∏ —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –∫–∞–º–µ—Ä—É üíÄ',
    '–¢–µ–≥ –¥—Ä—É–≥–∞ –∫–æ—Ç–æ—Ä—ã–π –¥—É–º–∞–µ—Ç —á—Ç–æ AI ‚Äî —ç—Ç–æ –µ—Ä—É–Ω–¥–∞ üëá',
    '–ö—Ç–æ —Å–æ–≥–ª–∞—Å–µ–Ω —Å {B} ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ —Ç–æ–º—É, –∫—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç ¬´—Ä–æ–±–æ—Ç—ã –Ω–∞—Å –∑–∞–º–µ–Ω—è—Ç¬ª üì±',
  ],
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': [
    '–û—Ç–ø—Ä–∞–≤—å —Ç–æ–º—É, –∫—Ç–æ —Å–µ–≥–æ–¥–Ω—è –±—ã–ª –≤ –º–∞–≥–∞–∑–∏–Ω–µ üõíüò≠',
    '–°–∫–∏–Ω—å –º–∞–º–µ ‚Äî –æ–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ üíÄ',
    '–¢–µ–≥ —Ç–æ–≥–æ, –∫—Ç–æ –ø–æ–º–Ω–∏—Ç —Ü–µ–Ω—ã –∏–∑ 90-—Ö üëá',
    '–ö—Ç–æ —É–∂–µ –ø–ª–∞—á–µ—Ç –Ω–∞ –∫–∞—Å—Å–µ ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤ —Ä–∞–±–æ—á–∏–π —á–∞—Ç ‚Äî –≤—Å–µ –ø–æ–π–º—É—Ç üì±',
  ],
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': [
    '–û—Ç–ø—Ä–∞–≤—å –ø–æ–¥—Ä—É–≥–µ –∫–æ—Ç–æ—Ä–∞—è –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –º—É–∂–∏–∫–æ–≤ üíÖüòÇ',
    '–°–∫–∏–Ω—å –ø–∞—Ä–Ω—é ‚Äî –ø—É—Å—Ç—å —É—á–∏—Ç—Å—è üíÄ',
    '–¢–µ–≥ —Ç–æ–≥–æ, –∫—Ç–æ —Ç–∞–∫ –∂–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è üëá',
    '–ö—Ç–æ —É–∑–Ω–∞–ª —Å–µ–±—è ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤ –∂–µ–Ω—Å–∫–∏–π —á–∞—Ç –∏ —Å—á–∏—Ç–∞–π —Ä–µ–∞–∫—Ü–∏–∏ üì±',
  ],
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': [
    '–°–∫–∏–Ω—å —ç—Ç–æ –±–∞–±—É—à–∫–µ ‚Äî —Å–Ω–∏–º–∞–π —Ä–µ–∞–∫—Ü–∏—é –Ω–∞ –∫–∞–º–µ—Ä—É üì±üòÇ',
    '–û—Ç–ø—Ä–∞–≤—å –≤ —Å–µ–º–µ–π–Ω—ã–π —á–∞—Ç ‚Äî –±–∞–±—É—à–∫–∞ –æ—Ü–µ–Ω–∏—Ç üíÄ',
    '–¢–µ–≥ –±—É–º–µ—Ä–∞ –∏ –∑—É–º–µ—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ üëá',
    '–ö—Ç–æ —Å–ª—ã—à–∞–ª —Ç–∞–∫–æ–µ –æ—Ç —Å—Ç–∞—Ä—à–∏—Ö ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤–Ω—É–∫–∞–º ‚Äî –∏–ª–∏ –±–∞–±—É—à–∫–µ ‚Äî –∫–æ–º—É —Å–º–µ–ª–µ–µ üì±',
  ],
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': [
    '–°–∫–∏–Ω—å –≤ —á–∞—Ç –¥–æ–º–∞ ‚Äî —Å–æ—Å–µ–¥–∏ –ø–æ–π–º—É—Ç üè†üòÇ',
    '–û—Ç–ø—Ä–∞–≤—å —É–ø—Ä–∞–≤–ª—è—é—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ üíÄ',
    '–¢–µ–≥ —Å–æ—Å–µ–¥–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–∂–µ –≤ —à–æ–∫–µ –æ—Ç –∫–≤–∏—Ç–∞–Ω—Ü–∏–π üëá',
    '–ö—Ç–æ –ø–ª–∞—Ç–∏—Ç –∑–∞ –ñ–ö–• ‚Äî —Å—Ç–∞–≤—å üî• (—Ç–æ –µ—Å—Ç—å –≤—Å–µ)',
    '–ü–µ—Ä–µ—à–ª–∏ —Ç–æ–º—É, –∫—Ç–æ –∂–∞–ª—É–µ—Ç—Å—è –Ω–∞ –±–∞—Ç–∞—Ä–µ–∏ üì±',
  ],
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': [
    '–°–∫–∏–Ω—å –∑–Ω–∞–∫–æ–º–æ–º—É –≤—Ä–∞—á—É ‚Äî –ø—É—Å—Ç—å –æ—Ü–µ–Ω–∏—Ç üè•üòÇ',
    '–û—Ç–ø—Ä–∞–≤—å —Ç–æ–º—É, –∫—Ç–æ –Ω–µ–Ω–∞–≤–∏–¥–∏—Ç –æ—á–µ—Ä–µ–¥–∏ –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–µ üíÄ',
    '–¢–µ–≥ –¥—Ä—É–≥–∞ –∫–æ—Ç–æ—Ä—ã–π –≥—É–≥–ª–∏—Ç –≤—Å–µ —Å–∏–º–ø—Ç–æ–º—ã üëá',
    '–ö—Ç–æ –ª–µ—á–∏–ª—Å—è –ø–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –º–∞–º–µ ‚Äî –æ–Ω–∞ —Å–∫–∞–∂–µ—Ç ¬´–º–Ω–µ —Ç–æ–∂–µ —Ç–∞–∫ —Å–∫–∞–∑–∞–ª–∏¬ª üì±',
  ],
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': [
    '–°–∫–∏–Ω—å –±–ª–æ–≥–µ—Ä—É ‚Äî –ø—É—Å—Ç—å –ø—Ä–æ–∑—Ä–µ–µ—Ç üì±üòÇ',
    '–û—Ç–ø—Ä–∞–≤—å —Ç–æ–º—É, –∫—Ç–æ —Å–Ω–∏–º–∞–µ—Ç —Ä–∏–ª—Å—ã –≤–º–µ—Å—Ç–æ —É–±–æ—Ä–∫–∏ üíÄ',
    '–¢–µ–≥ –¥—Ä—É–≥–∞ —Å –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ –±–æ–ª—å—à–µ —á–µ–º —É —Ç–µ–±—è üëá',
    '–ö—Ç–æ —Å–∏–¥–∏—Ç –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ 24/7 ‚Äî —Å—Ç–∞–≤—å üî• (–≤—Å–µ —Å—Ç–∞–≤–∏–º)',
    '–ü–µ—Ä–µ—à–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä—É –∏ –∂–¥–∏ –æ—Ç–≤–µ—Ç üì±',
  ],
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': [
    '–°–∫–∏–Ω—å –≤ –¥–∞—á–Ω—ã–π —á–∞—Ç ‚Äî –∫—Ç–æ-—Ç–æ —É–∑–Ω–∞–µ—Ç —Å–µ–±—è üå±üòÇ',
    '–û—Ç–ø—Ä–∞–≤—å –±–∞–±—É—à–∫–µ-–æ–≥–æ—Ä–æ–¥–Ω–∏—Ü–µ üíÄ',
    '–¢–µ–≥ —Å–æ—Å–µ–¥–∞ –ø–æ –¥–∞—á–µ üëá',
    '–ö—Ç–æ –ø–æ—Ç–µ—Ä—è–ª —É—Ä–æ–∂–∞–π ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤ —Å–µ–º–µ–π–Ω—ã–π —á–∞—Ç –¥–∞—á–Ω–∏–∫–æ–≤ üì±',
  ],
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': [
    '–°–∫–∏–Ω—å —Ç–æ–º—É, –∫—Ç–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å —Å—Ç–æ–∏—Ç –≤ –ø—Ä–æ–±–∫–µ üöóüòÇ',
    '–û—Ç–ø—Ä–∞–≤—å –¥—Ä—É–≥—É-–≤–æ–¥–∏—Ç–µ–ª—é ‚Äî –æ–Ω –ø–æ–π–º—ë—Ç üíÄ',
    '–¢–µ–≥ —Ç–æ–≥–æ, –∫—Ç–æ –µ–∑–¥–∏—Ç –Ω–∞ —Å–∞–º–æ–∫–∞—Ç–µ üëá',
    '–ö—Ç–æ —Å—Ç–æ—è–ª 2 —á–∞—Å–∞ –≤ –ø—Ä–æ–±–∫–µ ‚Äî —Å—Ç–∞–≤—å üî•',
    '–ü–µ—Ä–µ—à–ª–∏ –≤ —Ä–∞–±–æ—á–∏–π —á–∞—Ç ‚Äî –≤—Å–µ –æ–ø–∞–∑–¥—ã–≤–∞—é—â–∏–µ –æ—Ü–µ–Ω—è—Ç üì±',
  ],
};

// ‚îÄ‚îÄ‚îÄ FIRST COMMENTS ‚Äî –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è ‚îÄ‚îÄ
const FIRST_COMMENTS = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': [
    '–ê —É –≤–∞—Å –¥–æ–º–∞ —Ç–∞–∫ –∂–µ? –ò–ª–∏ —Ç–æ–ª—å–∫–æ —É –º–µ–Ω—è? üòÇ',
    '–ö—Ç–æ –ø—Ä–∞–≤ ‚Äî {A} –∏–ª–∏ {B}? –ñ–¥—É –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ö üëá',
    '{B} –∫–æ–Ω–µ—á–Ω–æ –∂—ë—Å—Ç–∫–æ –æ—Ç–≤–µ—Ç–∏–ª... –Ω–æ –≤–µ–¥—å –ø—Ä–∞–≤–¥–∞? ü§î',
    '–ú–æ–π —Å–æ—Å–µ–¥ ‚Äî 1 –≤ 1 –∫–∞–∫ {A} üíÄ –£ –∫–æ–≥–æ —Ç–∞–∫ –∂–µ?',
  ],
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': [
    '–ù–µ–π—Ä–æ—Å–µ—Ç–∏ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–º–µ–Ω—è—Ç –≤—Å–µ—Ö –∏–ª–∏ {A} –ø—Ä–∞–≤–∞? ü§î',
    '–ö—Ç–æ –±–æ–ª—å—à–µ –ø—Ä–∞–≤ ‚Äî {A} –∏–ª–∏ {B}? üëá',
    '–ú–æ—è –±–∞–±—É—à–∫–∞ —Ç–∞–∫–æ–µ –∂–µ —Å–∫–∞–∑–∞–ª–∞ –∫–æ–≥–¥–∞ —É–≤–∏–¥–µ–ª–∞ ChatGPT üíÄ',
    '–ê –≤–∞—à–∏ —Ä–æ–¥–∏—Ç–µ–ª–∏ –∑–Ω–∞—é—Ç —á—Ç–æ —Ç–∞–∫–æ–µ AI? –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ üëá',
  ],
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': [
    '–°–∫–æ–ª—å–∫–æ —É –≤–∞—Å –º–æ–ª–æ–∫–æ —Å—Ç–æ–∏—Ç? –î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º üëáüíÄ',
    '{A} –ø—Ä–∞–≤–∞ –∏–ª–∏ –º—ã —É–∂–µ –ø—Ä–∏–≤—ã–∫–ª–∏? ü§î',
    '–ü–æ–º–Ω–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏–ª —Ö–ª–µ–± 10 –ª–µ—Ç –Ω–∞–∑–∞–¥? üò≠',
    '–£ –∫–æ–≥–æ –µ—â—ë —à–æ–∫ –æ—Ç —Ü–µ–Ω –≤ 2026? üëá',
  ],
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': [
    '{B} –ø—Ä–∞–≤? –ò–ª–∏ —Å–µ–π—á–∞—Å –¥—Ä—É–≥–∏–µ –≤—Ä–µ–º–µ–Ω–∞? ü§î',
    '–î–µ–≤–æ—á–∫–∏, –≤–∞—à —Ç–∞–∫ –∂–µ –ø–∏—à–µ—Ç? üëáüòÇ',
    '–ö—Ç–æ —Å–æ–≥–ª–∞—Å–µ–Ω —Å {B} ‚Äî –ª–∞–π–∫, –∫—Ç–æ —Å {A} ‚Äî –∫–æ–º–º–µ–Ω—Ç üëá',
    '–ü–æ–∫–∞–∂–∏—Ç–µ —ç—Ç–æ —Å–≤–æ–µ–º—É –ø–∞—Ä–Ω—é ‚Äî –∏ –Ω–∞–ø–∏—à–∏—Ç–µ –µ–≥–æ —Ä–µ–∞–∫—Ü–∏—é üíÄ',
  ],
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': [
    '–í—ã –±–æ–ª—å—à–µ {A} –∏–ª–∏ {B}? ü§î –ß–µ—Å—Ç–Ω–æ!',
    '–ü–æ–∫–∞–∂–∏—Ç–µ –±–∞–±—É—à–∫–µ –∏ —Å–Ω–∏–º–∏—Ç–µ —Ä–µ–∞–∫—Ü–∏—é üì±üëá',
    '–ó—É–º–µ—Ä—ã vs –±—É–º–µ—Ä—ã ‚Äî –≤–µ—á–Ω–∞—è –±–∏—Ç–≤–∞. –ö—Ç–æ –ø—Ä–∞–≤? üëá',
    '–ú–æ—è –±–∞–±—É—à–∫–∞ —Å–∫–∞–∑–∞–ª–∞ —Ç–æ –∂–µ —Å–∞–º–æ–µ —Å–ª–æ–≤–æ –≤ —Å–ª–æ–≤–æ üíÄ',
  ],
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': [
    '–°–∫–æ–ª—å–∫–æ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ –∑–∞ –∫–æ–º–º—É–Ω–∞–ª–∫—É? –î–∞–≤–∞–π—Ç–µ —Å—Ä–∞–≤–Ω–∏–º üëáüíÄ',
    '{A} –ø—Ä–∞–≤–∞, –∏ –≤—ã —ç—Ç–æ –∑–Ω–∞–µ—Ç–µ üò§',
    '–£ –∫–æ–≥–æ –±–∞—Ç–∞—Ä–µ–∏ —Ç–æ–∂–µ —Ö–æ–ª–æ–¥–Ω—ã–µ? üëáü•∂',
    '–ù–∞–ø–∏—à–∏—Ç–µ —Å—É–º–º—É –≤–∞—à–µ–π –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ ‚Äî —Å—Ä–∞–≤–Ω–∏–º –∫—Ç–æ –±–æ–ª—å—à–µ —Å—Ç—Ä–∞–¥–∞–µ—Ç üíÄ',
  ],
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': [
    '–í–∞–º —Ç–æ–∂–µ —Ç–∞–∫ –≤—Ä–∞—á –≥–æ–≤–æ—Ä–∏–ª? üëáüòÇ',
    '{B} –∂—ë—Å—Ç–∫–æ, –Ω–æ –ø—Ä–∞–≤–¥–∞ –∂–µ? üíÄ',
    '–£ –∫–æ–≥–æ –±—ã–ª–∏ –ø—Ä–∏–∫–æ–ª—ã –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–µ? –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π—Ç–µ üëá',
    '–ì—É–≥–ª–∏—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –∏–ª–∏ –∏–¥—ë—Ç–µ –∫ –≤—Ä–∞—á—É? –ß–µ—Å—Ç–Ω–æ ü§î',
  ],
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': [
    '–£ –∫–æ–≥–æ —Ä–µ–±—ë–Ω–æ–∫ —Ç–æ–∂–µ ¬´–∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä¬ª? üëáüòÇ',
    '{B} –ø—Ä–∞–≤–¥–∞ –∏–ª–∏ –∂—ë—Å—Ç–∫–æ? ü§î',
    '–°–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –¥–µ–Ω—å —Å–∏–¥–∏—Ç–µ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ? –ß–µ—Å—Ç–Ω–æ üëá',
    '–ë–ª–æ–≥–µ—Ä—ã ‚Äî —ç—Ç–æ —Ä–∞–±–æ—Ç–∞ –∏–ª–∏ –Ω–µ—Ç? –ü–æ–≥–Ω–∞–ª–∏ —Å–ø–æ—Ä–∏—Ç—å üëáüî•',
  ],
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': [
    '–£ –∫–æ–≥–æ —Å–æ—Å–µ–¥–∏ —Ç–æ–∂–µ —Ç–∞–∫–∏–µ? üëáüòÇ',
    '–í–∞—à —É—Ä–æ–∂–∞–π –≤ —ç—Ç–æ–º –≥–æ–¥—É ‚Äî –æ—Ü–µ–Ω–∏—Ç–µ –æ—Ç 1 –¥–æ 10 üçÖ',
    '{A} —Ä–µ–∞–ª—å–Ω–æ —Ç–∞–∫ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –∑–∞ –ø–æ–º–∏–¥–æ—Ä—ã? –ê –≤—ã? üëá',
    '–î–∞—á–Ω–∏–∫–∏ –ø–æ–π–º—É—Ç. –ö—Ç–æ –Ω–µ –¥–∞—á–Ω–∏–∫ ‚Äî –Ω–µ –ø–æ–π–º—ë—Ç ü§∑‚Äç‚ôÇÔ∏è',
  ],
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': [
    '–°–∫–æ–ª—å–∫–æ –≤—ã —Å—Ç–æ–∏—Ç–µ –≤ –ø—Ä–æ–±–∫–∞—Ö –≤ –¥–µ–Ω—å? üëá‚è∞',
    '{B} –ø—Ä–∞–≤ ‚Äî —Å–∞–º–æ–∫–∞—Ç —Ä–µ–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ? ü§î',
    '–í–æ–¥–∏—Ç–µ–ª–∏ vs –ø–µ—à–µ—Ö–æ–¥—ã ‚Äî –∫—Ç–æ —Å—Ç—Ä–∞–¥–∞–µ—Ç –±–æ–ª—å—à–µ? üëá',
    '–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Ä–µ–∫–æ—Ä–¥ –ø—Ä–æ–±–∫–∏ –≤ —á–∞—Å–∞—Ö üíÄ',
  ],
};

const DEMO_DIALOGUES = {
  '–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥': {
    A_lines: ['–¢—ã –≤–∏–¥–µ–ª —á—Ç–æ –æ–Ω–∏ —Å —Ö–ª–µ–±–æ–º —Å–¥–µ–ª–∞–ª–∏?! | –ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–π! –ö–í–ê–î–†–ê–¢–ù–´–ô!', '–ü—É–ª—å—Ç! | –û–ø—è—Ç—å –ø—É–ª—å—Ç –ø–æ—Ç–µ—Ä—è–ª–∞! | –¢—Ä–µ—Ç–∏–π —Ä–∞–∑ –∑–∞ –¥–µ–Ω—å!'],
    B_lines: ['–ò —á—ë? | –ó–µ–º–ª—è —Ç–æ–∂–µ –Ω–µ –∫—Ä—É–≥–ª–∞—è | –∞ —Ç—ã –Ω–∞ –Ω–µ–π –∂–∏–≤—ë—à—å.', '–ú–æ–∂–µ—Ç —Ö–≤–∞—Ç–∏—Ç | –µ–≥–æ –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫ –∫–ª–∞—Å—Ç—å | —Ç—ã –∂ –Ω–µ –∫–∞–Ω–∞–ª –∏—â–µ—à—å.'],
    killer_word: '–∂–∏–≤—ë—à—å'
  },
  'AI –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏': {
    A_lines: ['–≠—Ç–æ—Ç —Ç–≤–æ–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç | –º–Ω–µ –ë–û–†–© —Å–≤–∞—Ä–∏—Ç?!', '–û–Ω–∞ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç! | –° –¢–ï–õ–ï–§–û–ù–û–ú! | –ö–∞–∫ —Å —á–µ–ª–æ–≤–µ–∫–æ–º!'],
    B_lines: ['–û–Ω —Ç–µ–±–µ —É–∂–µ –≤–Ω—É–∫–æ–≤ –≤–æ—Å–ø–∏—Ç—ã–≤–∞–µ—Ç | –∞ —Ç—ã –Ω–µ –∑–∞–º–µ—Ç–∏–ª–∞.', '–ê —Ç—ã —Å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–æ–º | —Ç—Ä–∏–¥—Ü–∞—Ç—å –ª–µ—Ç —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å | –∏ –Ω–∏—á–µ–≥–æ.'],
    killer_word: '–∑–∞–º–µ—Ç–∏–ª–∞'
  },
  '–¶–µ–Ω—ã –∏ –∏–Ω—Ñ–ª—è—Ü–∏—è': {
    A_lines: ['–ó–∞ –ú–û–õ–û–ö–û! | –í–æ—Å–µ–º—å—Å–æ—Ç —Ä—É–±–ª–µ–π! –ó–∞ *–º–æ–ª–æ–∫–æ*!', '–Ø–π—Ü–∞! | –ü–æ —Ç—Ä–∏—Å—Ç–∞ —Ä—É–±–ª–µ–π! | –î–µ—Å—è—Ç–æ–∫! –Ø–ô–¶–ê!'],
    B_lines: ['–í –¥–µ–≤—è–Ω–æ—Å—Ç–æ —Ç—Ä–µ—Ç—å–µ–º | –∑–∞ —ç—Ç–∏ –¥–µ–Ω—å–≥–∏ | —è –º–∞—à–∏–Ω—É –∫—É–ø–∏–ª.', '–ó–∞—Ç–æ –∫—É—Ä–∏—Ü–∞ | —Ç–µ–ø–µ—Ä—å –∂–∏–≤—ë—Ç | –ª—É—á—à–µ –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–∞.'],
    killer_word: '–º–∞—à–∏–Ω—É'
  },
  '–û—Ç–Ω–æ—à–µ–Ω–∏—è': {
    A_lines: ['–û–Ω –º–Ω–µ –ø–∏—à–µ—Ç | ¬´–ø—Ä–∏–≤–µ—Ç –∫–∞–∫ –¥–µ–ª–∞¬ª | –≠—Ç–æ —á—Ç–æ ‚Äî –£–•–ê–ñ–ò–í–ê–ù–ò–ï?!', '–ú—É–∂ –≥–æ–≤–æ—Ä–∏—Ç | ¬´—Ç—ã –ø—Ä–∞–≤–∞ –¥–æ—Ä–æ–≥–∞—è¬ª | –ü—è—Ç—å –ª–µ—Ç! –û–¥–Ω—É –∏ —Ç—É –∂–µ —Ñ—Ä–∞–∑—É!'],
    B_lines: ['–í –Ω–∞—à–µ –≤—Ä–µ–º—è | –º—É–∂–∏–∫ –º–æ–ª—á–∞ –∑–∞–±–æ—Ä —á–∏–Ω–∏–ª | –∏ —ç—Ç–æ –±—ã–ª–∞ –ª—é–±–æ–≤—å.', '–≠—Ç–æ –∑–Ω–∞—á–∏—Ç | –æ–Ω –¥–∞–≤–Ω–æ —Å–¥–∞–ª—Å—è | –∏ –∂–∏–≤—ë—Ç —Å–ø–æ–∫–æ–π–Ω–æ.'],
    killer_word: '–ª—é–±–æ–≤—å'
  },
  '–†–∞–∑—Ä—ã–≤ –ø–æ–∫–æ–ª–µ–Ω–∏–π': {
    A_lines: ['–í–Ω—É—á–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç ‚Äî —è —Ç–µ–ø–µ—Ä—å | ¬´–∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä¬ª | –ß—ë —ç—Ç–æ?!', '–í–Ω—É–∫ –º–Ω–µ –≥–æ–≤–æ—Ä–∏—Ç | ¬´–æ–∫ –±—É–º–µ—Ä¬ª | –ö–∞–∫–æ–π —è —Ç–µ–±–µ –ë–£–ú–ï–†?!'],
    B_lines: ['–≠—Ç–æ –∑–Ω–∞—á–∏—Ç | –æ–Ω–∞ —Ç–æ–∂–µ –Ω–∏—Ö—Ä–µ–Ω–∞ –Ω–µ –¥–µ–ª–∞–µ—Ç | –Ω–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º.', '–ë—É–º–µ—Ä —ç—Ç–æ —Ç–æ—Ç | –∫—Ç–æ –ø–æ—Å—Ç—Ä–æ–∏–ª –¥–æ–º | –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã –≤–∞–π—Ñ–∞–π –ª–æ–≤–∏—à—å.'],
    killer_word: '—Ç–µ–ª–µ—Ñ–æ–Ω–æ–º'
  },
  '–ñ–ö–• –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞': {
    A_lines: ['–ó–∞ –æ—Ç–æ–ø–ª–µ–Ω–∏–µ | —à–µ—Å—Ç—å —Ç—ã—â! | –ê –±–∞—Ç–∞—Ä–µ—è –•–û–õ–û–î–ù–ê–Ø!', '–õ–∏—Ñ—Ç! | –û–ø—è—Ç—å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! | –®–µ—Å—Ç–æ–π —ç—Ç–∞–∂ –ü–ï–®–ö–û–ú!'],
    B_lines: ['–ó–∞—Ç–æ –¥—É—à—É | –æ–Ω–∏ —Ç–µ–±–µ –¥–∞–≤–Ω–æ | –Ω–∞—Ç–æ–ø–∏–ª–∏.', '–ó–∞—Ç–æ –Ω–æ–≥–∏ | —É —Ç–µ–±—è –∫—Ä–∞—Å–∏–≤—ã–µ –±—É–¥—É—Ç | –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å.'],
    killer_word: '–Ω–∞—Ç–æ–ø–∏–ª–∏'
  },
  '–ó–¥–æ—Ä–æ–≤—å–µ –∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∞': {
    A_lines: ['–í—Ä–∞—á –≥–æ–≤–æ—Ä–∏—Ç | ¬´–≥—É–≥–ª–∏—Ç–µ¬ª | –°–µ—Ä—å—ë–∑–Ω–æ?! –ì–£–ì–õ–ò–¢–ï?!', '–ó–∞–ø–∏—Å–∞–ª–∞—Å—å –∫ –≤—Ä–∞—á—É | —á–µ—Ä–µ–∑ –¢–†–ò –Ω–µ–¥–µ–ª–∏! | –Ø —É–∂–µ –≤—ã–∑–¥–æ—Ä–æ–≤–µ—é!'],
    B_lines: ['–•–æ—Ä–æ—à–æ —á—Ç–æ –Ω–µ —Å–∫–∞–∑–∞–ª | ¬´—Å–ø—Ä–æ—Å–∏—Ç–µ —É –Ω–µ–π—Ä–æ—Å–µ—Ç–∏¬ª | —Ç–∞ –≤–æ–æ–±—â–µ –ø–æ—Ö–æ—Ä–æ–Ω–∏—Ç.', '–í–æ—Ç –≤–∏–¥–∏—à—å | —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç | —ç–∫–æ–Ω–æ–º—è—Ç –Ω–∞ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞—Ö.'],
    killer_word: '–ø–æ—Ö–æ—Ä–æ–Ω–∏—Ç'
  },
  '–°–æ—Ü—Å–µ—Ç–∏ –∏ —Ç—Ä–µ–Ω–¥—ã': {
    A_lines: ['–£ –Ω–µ—ë –º–∏–ª–ª–∏–æ–Ω –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤! | –ú–ò–õ–õ–ò–û–ù! | –ê –ø–æ—Å—É–¥—É –Ω–µ –º–æ–µ—Ç!', '–û–Ω–∞ –µ–¥—É —Ñ–æ—Ç–∫–∞–µ—Ç! | –ß–∞—Å —Ñ–æ—Ç–∫–∞–µ—Ç! | –°—É–ø –æ—Å—Ç—ã–ª –î–ê–í–ù–û!'],
    B_lines: ['–ú–∏–ª–ª–∏–æ–Ω –ª—é–¥–µ–π | —Å–º–æ—Ç—Ä—è—Ç –∫–∞–∫ –æ–Ω–∞ –Ω–µ –º–æ–µ—Ç | –∏ –ª–∞–π–∫–∞—é—Ç.', '–ó–∞—Ç–æ –º–∏–ª–ª–∏–æ–Ω –ª—é–¥–µ–π | –∑–Ω–∞—é—Ç —á—Ç–æ —Ç—ã –≤–∞—Ä–∏—à—å | –≥–æ—Ä–¥–∏—Å—å.'],
    killer_word: '–ª–∞–π–∫–∞—é—Ç'
  },
  '–î–∞—á–∞ –∏ –æ–≥–æ—Ä–æ–¥': {
    A_lines: ['–ü–æ–º–∏–¥–æ—Ä—ã! | –°–æ–∂—Ä–∞–ª–∏! | –í—Å–µ –¥–æ –µ–¥–∏–Ω–æ–≥–æ! –ö–¢–û?!', '–°–æ—Å–µ–¥! | –ó–∞–±–æ—Ä –ø–µ—Ä–µ–¥–≤–∏–Ω—É–ª! | –ù–∞ –î–í–ê–î–¶–ê–¢–¨ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤!'],
    B_lines: ['–°–æ—Å–µ–¥ –ú–∏—Ö–∞–ª—ã—á | –æ–Ω –∂–µ —Ç–µ–ø–µ—Ä—å –≤–µ–≥–∞–Ω | –µ–º—É –ø–æ–ª–æ–∂–µ–Ω–æ.', '–î–≤–∞–¥—Ü–∞—Ç—å —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤ | —ç—Ç–æ –µ–≥–æ —Å–æ–≤–µ—Å—Ç—å | —Ä–∞—Å—Ç—ë—Ç –≤ –Ω–∞—à—É —Å—Ç–æ—Ä–æ–Ω—É.'],
    killer_word: '–ø–æ–ª–æ–∂–µ–Ω–æ'
  },
  '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø—Ä–æ–±–∫–∏': {
    A_lines: ['–î–≤–∞ —á–∞—Å–∞! | –î–í–ê –ß–ê–°–ê —Å—Ç–æ—è–ª–∞! | –°–∞–º–æ–∫–∞—Ç –æ–±–æ–≥–Ω–∞–ª!', '–¢–∞–∫—Å–∏—Å—Ç! | –î–≤–µ—Å—Ç–∏ —Ä—É–±–ª–µ–π | –∑–∞ –ü–Ø–¢–¨–°–û–¢ –º–µ—Ç—Ä–æ–≤!'],
    B_lines: ['–°–∞–º–æ–∫–∞—Ç | —ç—Ç–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –±—É–¥—É—â–µ–≥–æ | –∞ —Ç—ã ‚Äî –ø—Ä–æ—à–ª–æ–≥–æ.', '–ó–∞—Ç–æ –¥–æ–≤—ë–∑ | –±–µ–∑ –ø—Ä–æ–±–∫–∏ | –∑–∞ –ø—è—Ç—å—Å–æ—Ç –º–µ—Ç—Ä–æ–≤ –ø—Ä–æ–±–æ–∫ –Ω–µ—Ç.'],
    killer_word: '–ø—Ä–æ—à–ª–æ–≥–æ'
  },
};

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function seededRandom(seed) {
  let h = 0;
  for (let i = 0; i < seed.length; i++) { h = ((h << 5) - h + seed.charCodeAt(i)) | 0; }
  return () => { h = (h * 16807 + 0) % 2147483647; return (h & 0x7fffffff) / 2147483647; };
}

function pickRandom(arr, rng) { return arr[Math.floor(rng() * arr.length)]; }
function pickN(arr, n, rng) {
  const copy = [...arr];
  const result = [];
  for (let i = 0; i < Math.min(n, copy.length); i++) {
    const idx = Math.floor(rng() * copy.length);
    result.push(copy.splice(idx, 1)[0]);
  }
  return result;
}

// ‚îÄ‚îÄ‚îÄ ENGAGEMENT BUILDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildEngagement(catRu, charA, charB, rng) {
  const nameA = charA.name_ru;
  const nameB = charB.name_ru;
  const fill = (s) => s.replace(/\{A\}/g, nameA).replace(/\{B\}/g, nameB);

  // ‚îÄ‚îÄ Hashtags: 3-layer mix ‚îÄ‚îÄ
  const catTags = HASHTAGS_BY_CATEGORY[catRu] || HASHTAGS_BY_CATEGORY['–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥'];
  const niche = pickN(catTags.niche, 5, rng);
  const mid = pickN(catTags.mid, 4, rng);
  const big = pickN(catTags.big, 2, rng);
  const evergreen = pickN(EVERGREEN_TAGS, 3, rng);

  // –ü–µ—Ä—Å–æ–Ω–∞–∂–Ω—ã–µ —Ç–µ–≥–∏
  const grpA = GROUP_HASHTAGS[charA.group] || [];
  const grpB = GROUP_HASHTAGS[charB.group] || [];
  const charTags = pickN([...new Set([...grpA, ...grpB])], 3, rng);

  // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–µ–≥ —Å–µ—Ä–∏–∏
  const seriesTag = '#' + nameA.replace(/\s+/g, '').toLowerCase() + 'vs' + nameB.replace(/\s+/g, '').toLowerCase();

  // –°–±–æ—Ä–∫–∞: niche(5) + mid(4) + charTags(3) + big(2) + evergreen(3) + series(1) = ~18 —Ç–µ–≥–æ–≤ (–∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è IG)
  const allTags = [...niche, ...mid, ...charTags, ...big, ...evergreen, seriesTag];
  // –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
  const hashtags = [...new Set(allTags)].slice(0, 25);

  // ‚îÄ‚îÄ Viral title ‚îÄ‚îÄ
  const titlePool = VIRAL_TITLES[catRu] || VIRAL_TITLES['–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥'];
  const viralTitle = fill(pickRandom(titlePool, rng));

  // ‚îÄ‚îÄ Pin comment ‚îÄ‚îÄ
  const pinPool = PIN_COMMENTS[catRu] || PIN_COMMENTS['–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥'];
  const pinComment = fill(pickRandom(pinPool, rng));

  // ‚îÄ‚îÄ First comment (–¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è) ‚îÄ‚îÄ
  const fcPool = FIRST_COMMENTS[catRu] || FIRST_COMMENTS['–ë—ã—Ç–æ–≤–æ–π –∞–±—Å—É—Ä–¥'];
  const firstComment = fill(pickRandom(fcPool, rng));

  return { hashtags, viralTitle, pinComment, firstComment, seriesTag };
}

// ‚îÄ‚îÄ‚îÄ UNIVERSAL ROLE ADAPTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Maps any character pair to A/B roles based on their data.
// A = more expressive/provocative; B = more grounded/rational.
// User manual assignment (role_default) takes priority.
function resolveRoles(charA, charB) {
  // If user explicitly assigned roles, respect that
  if (charA.role_default === 'A' && charB.role_default === 'B') return { A: charA, B: charB };
  if (charA.role_default === 'B' && charB.role_default === 'A') return { A: charB, B: charA };

  // Auto-assign: compute expressiveness score
  // Higher score ‚Üí role A (provocateur)
  const score = (c) => {
    let s = 0;
    if (c.speech_pace === 'fast') s += 3;
    else if (c.speech_pace === 'normal') s += 1;
    s += c.swear_level || 0;
    if (c.compatibility === 'chaotic') s += 2;
    else if (c.compatibility === 'conflict') s += 1;
    else if (c.compatibility === 'calm') s -= 2;
    if (c.role_default === 'A') s += 1;
    if (c.role_default === 'B') s -= 1;
    return s;
  };

  const scoreA = score(charA);
  const scoreB = score(charB);
  // Higher score gets role A
  if (scoreB > scoreA) return { A: charB, B: charA };
  return { A: charA, B: charB };
}

// ‚îÄ‚îÄ‚îÄ CAST CONTRACT BUILDER (universal) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCastContract(charA, charB) {
  const buildBiology = (char, role) => {
    const bio = char.biology_override || {};
    const anchors = char.identity_anchors || {};
    const defaultSkin = ['deep wrinkles', 'age spots', 'visible pores', 'subtle skin sheen (not plastic)'];
    const defaultEyes = ['wet glint', 'slight sclera redness', 'micro-saccades'];
    return {
      character_en: char.prompt_tokens?.character_en || 'elderly character, hyper-realistic detail',
      age: bio.age || 'elderly',
      skin: (bio.skin_tokens || defaultSkin).join(', '),
      eyes: (bio.eye_tokens || defaultEyes).join(', '),
      mouth: role === 'A'
        ? 'realistic teeth/gums, lip moisture, lip-bite as comedic pafos-anchor (sparingly), micro saliva glints'
        : 'realistic teeth/gums, lip moisture, mouth SEALED when not speaking, jaw still',
      face_silhouette: anchors.face_silhouette || 'distinctive facial features',
      signature_element: anchors.signature_element || 'notable accessory',
      micro_gesture: anchors.micro_gesture || 'subtle expression change',
      wardrobe_anchor: anchors.wardrobe_anchor || 'distinctive clothing piece',
      vibe: char.vibe_archetype || (role === 'A' ? '–ø—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä' : '–±–∞–∑–∞'),
    };
  };
  return {
    speaker_A: buildBiology(charA, 'A'),
    speaker_B: buildBiology(charB, 'B'),
    relationship: 'BAND ‚Äî insults target SITUATION only, never each other',
  };
}

// ‚îÄ‚îÄ‚îÄ CAMERA & REALISM PRESET (v2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCameraPreset() {
  return {
    pov: 'held at arm\'s length, front-facing portrait look, device INVISIBLE',
    distance: 'close enough to read skin microtexture, both faces in frame',
    artifacts: [
      'handheld micro-jitter',
      'subtle exposure breathing',
      'mild rolling shutter only on quick micro-moves',
      'brief autofocus hunt ‚â§0.15s on lens approach',
    ],
    realism_anchors: [
      'slight sensor noise',
      'mild compression artifacts',
      'imperfect white balance drift',
      'micro motion blur on sharp gesture (finger/slap)',
      'realistic shadowing under nose/cheekbones',
    ],
  };
}

// ‚îÄ‚îÄ‚îÄ TIMING GRID BUILDER (v2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTimingGridV2(hookObj, releaseObj) {
  return {
    total_seconds: 8.0,
    tolerance_s: 0.2,
    grid: [
      { segment: 'hook', ...GRID_V2.hook, action_en: hookObj.action_en, audio: hookObj.audio },
      { segment: 'act_A', ...GRID_V2.act_A, action_en: 'Speaker A delivers short pompous provocation (6-9 words), animated gestures, direct camera gaze', other: 'B silent: sealed lips, jaw still, eyes/micro-reactions only' },
      { segment: 'act_B', ...GRID_V2.act_B, action_en: 'Speaker B responds with punchline (6-11 words), measured delivery building to killer word near end', other: 'A frozen in pose, mouth closed' },
      { segment: 'release', ...GRID_V2.release, action_en: releaseObj.action_en, audio: releaseObj.audio, note: 'ZERO words, shared laughter only' },
    ],
  };
}

// ‚îÄ‚îÄ‚îÄ QC GATE (v2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Pre-flight check on generated package. Returns pass/fail + details.
function runQCGate(blueprint, cast) {
  const checks = [
    { id: 1, name: 'face_stability', pass: !!cast.speaker_A.face_silhouette && !!cast.speaker_B.face_silhouette, hard: true },
    { id: 2, name: 'skin_microtexture', pass: cast.speaker_A.skin.includes('pores') || cast.speaker_A.skin.includes('wrinkles'), hard: false },
    { id: 3, name: 'eyes_alive', pass: cast.speaker_A.eyes.includes('saccades') || cast.speaker_A.eyes.includes('glint'), hard: false },
    { id: 4, name: 'mouth_realistic', pass: cast.speaker_A.mouth.includes('teeth') || cast.speaker_A.mouth.includes('lip'), hard: true },
    { id: 5, name: 'silent_sealed', pass: cast.speaker_B.mouth.includes('SEALED') || cast.speaker_B.mouth.includes('sealed'), hard: true },
    { id: 6, name: 'background_solid', pass: blueprint.scenes.every(s => !s.action?.includes('pattern') && !s.action?.includes('abstract')), hard: false },
    { id: 7, name: 'camera_artifacts', pass: !!blueprint.scenes.find(s => s.segment === 'hook')?.speech_hints, hard: false },
    { id: 8, name: 'audio_no_overlap', pass: blueprint.scenes.every((s, i, arr) => i === 0 || s.start >= arr[i - 1].end - 0.05), hard: false },
    { id: 9, name: 'hook_readable', pass: blueprint.scenes[0].end <= 0.85, hard: false },
    { id: 10, name: 'laugh_natural', pass: blueprint.scenes[blueprint.scenes.length - 1].dialogue_ru === '', hard: false },
  ];
  const passed = checks.filter(c => c.pass).length;
  const hardFails = checks.filter(c => c.hard && !c.pass);
  return {
    passed,
    total: checks.length,
    ok: passed >= 9 && hardFails.length === 0,
    hard_fails: hardFails.map(c => c.name),
    details: checks,
  };
}

export function getRandomCategory(seed) {
  const rng = seededRandom(seed || Date.now().toString());
  return pickRandom(HUMOR_CATEGORIES, rng);
}

export function generate(input) {
  const {
    input_mode = 'idea',
    character1_id, character2_id,
    context_ru, script_ru, scene_hint_ru,
    category, thread_memory, video_meta,
    product_info,
    options = {}, seed = Date.now().toString(),
    characters = []
  } = input;

  const rng = seededRandom(seed);
  const rawA = characters.find(c => c.id === character1_id) || characters[0];
  const rawB = characters.find(c => c.id === character2_id) || characters[1] || characters[0];

  if (!rawA || !rawB) {
    return { error: 'Characters not found', warnings: ['–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤—É—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π'] };
  }

  const { A: charA, B: charB } = resolveRoles(rawA, rawB);
  const cat = category || pickRandom(HUMOR_CATEGORIES, rng);

  // ‚îÄ‚îÄ Topic context (from user input) ‚îÄ‚îÄ
  // This is the KEY missing piece ‚Äî user's idea/context must influence ALL prompts
  const topicRu = context_ru?.trim() || '';
  const sceneHint = scene_hint_ru?.trim() || '';
  const topicEn = topicRu ? `The comedic argument is specifically about: "${topicRu}".` : '';
  const topicForScene = topicRu ? ` The argument topic: ${cat.en.toLowerCase()} ‚Äî ${topicRu}.` : ` The argument topic: ${cat.en.toLowerCase()}.`;

  // ‚îÄ‚îÄ Location (category-aware + avoid repeats) ‚îÄ‚îÄ
  const locHints = LOCATION_HINTS[cat.ru] || [];
  let location;
  if (locHints.length > 0) {
    // Pick from category-preferred locations, avoid repeats
    const preferred = locHints.map(i => LOCATIONS[i]).filter(l => !historyCache.hasLocation(l));
    if (preferred.length > 0) {
      location = preferred[Math.floor(rng() * preferred.length)];
    } else {
      location = LOCATIONS[locHints[Math.floor(rng() * locHints.length)]];
    }
  } else {
    const locIdx = Math.floor(rng() * LOCATIONS.length);
    location = LOCATIONS[locIdx];
    if (historyCache.hasLocation(location)) {
      location = LOCATIONS[(locIdx + 1) % LOCATIONS.length];
    }
  }

  // ‚îÄ‚îÄ Lighting (varies by location type) ‚îÄ‚îÄ
  const lightingMood = pickRandom(LIGHTING_MOODS, rng);

  // ‚îÄ‚îÄ Wardrobe from character anchors (full description, not just a keyword) ‚îÄ‚îÄ
  const wardrobeA = charA.identity_anchors?.wardrobe_anchor || 'silk floral blouse with mother-of-pearl buttons, velvet collar';
  const wardrobeB = charB.identity_anchors?.wardrobe_anchor || 'worn striped sailor telnyashka under patched corduroy jacket, leather belt';

  // ‚îÄ‚îÄ Hook & Release ‚îÄ‚îÄ
  const hookObj = pickRandom(HOOK_ACTIONS, rng);
  const releaseObj = pickRandom(RELEASE_ACTIONS, rng);

  // ‚îÄ‚îÄ Serial prop anchor (category-aware + avoid repeats) ‚îÄ‚îÄ
  const propHints = PROP_HINTS[cat.ru] || [];
  let propAnchor;
  if (propHints.length > 0) {
    const preferred = propHints.filter(p => !historyCache.hasProp(p));
    propAnchor = preferred.length > 0
      ? preferred[Math.floor(rng() * preferred.length)]
      : propHints[Math.floor(rng() * propHints.length)];
  } else {
    let propIdx = Math.floor(rng() * PROP_ANCHORS.length);
    propAnchor = PROP_ANCHORS[propIdx];
    if (historyCache.hasProp(propAnchor)) {
      propAnchor = PROP_ANCHORS[(propIdx + 1) % PROP_ANCHORS.length];
    }
  }

  // ‚îÄ‚îÄ Dialogue based on mode ‚îÄ‚îÄ
  let dialogueA, dialogueB, killerWord;
  const demoKey = (cat.ru in DEMO_DIALOGUES) ? cat.ru : Object.keys(DEMO_DIALOGUES)[Math.floor(rng() * Object.keys(DEMO_DIALOGUES).length)];
  const demo = DEMO_DIALOGUES[demoKey];

  // Pick random dialogue variant (now 2+ options per category)
  const demoIdx = Math.floor(rng() * demo.A_lines.length);

  if (input_mode === 'script' && script_ru) {
    dialogueA = script_ru.A || demo.A_lines[demoIdx];
    dialogueB = script_ru.B || demo.B_lines[demoIdx];
    killerWord = dialogueB.split(/\s+/).pop()?.replace(/[^–∞-—è—ëa-z]/gi, '') || '–ø–∞–Ω—á';
  } else if (input_mode === 'video' && video_meta) {
    dialogueA = demo.A_lines[demoIdx];
    dialogueB = demo.B_lines[demoIdx];
    killerWord = demo.killer_word;
  } else {
    dialogueA = demo.A_lines[demoIdx];
    dialogueB = demo.B_lines[demoIdx];
    killerWord = demo.killer_word;
  }

  // ‚îÄ‚îÄ Estimate duration ‚îÄ‚îÄ
  const lines = [
    { speaker: 'A', text: dialogueA, pace: charA.speech_pace },
    { speaker: 'B', text: dialogueB, pace: charB.speech_pace },
  ];

  let estimate = estimateDialogue(lines, { enforce8s: options.enforce8s !== false });
  let autoFixes = [];

  if (options.allowAutoTrim && estimate.risk === 'high') {
    const trimResult = autoTrim(lines, {});
    if (trimResult.trimmed) {
      dialogueA = trimResult.lines[0]?.text || dialogueA;
      dialogueB = trimResult.lines[1]?.text || dialogueB;
      autoFixes = trimResult.auto_fixes;
      estimate = trimResult.estimate;
    }
  }

  // ‚îÄ‚îÄ Safety: scan banned words (apply replacements) ‚îÄ‚îÄ
  const safeA = scanBannedWords(dialogueA);
  const safeB = scanBannedWords(dialogueB);
  dialogueA = safeA.text;
  dialogueB = safeB.text;
  if (safeA.fixes.length) autoFixes.push(...safeA.fixes);
  if (safeB.fixes.length) autoFixes.push(...safeB.fixes);

  // ‚îÄ‚îÄ Build all blocks ‚îÄ‚îÄ
  const cast = buildCastContract(charA, charB);
  const cameraPreset = buildCameraPreset();
  const timingGrid = buildTimingGridV2(hookObj, releaseObj);
  const aesthetic = charA.world_aesthetic || charB.world_aesthetic || 'VIP-–¥–µ—Ä–µ–≤–µ–Ω—Å–∫–∏–π —É—é—Ç';

  // ‚îÄ‚îÄ PHOTO PROMPT (EN) ‚îÄ‚îÄ
  const anchorA = charA.identity_anchors || {};
  const anchorB = charB.identity_anchors || {};

  const photo_prompt_en_json = {
    scene: `Hyper-realistic close-up still frame captured mid-argument. Two characters in heated comedic confrontation, faces 40-60cm from camera.${topicForScene} ${location}. ${lightingMood.style}. ${aesthetic} aesthetic. Mood: ${lightingMood.mood}. Vertical 9:16 aspect ratio, 1080x1920px.`,
    ...(topicEn ? { topic_context: topicEn } : {}),
    characters: [
      {
        role: 'A ‚Äî provocateur (speaking)',
        appearance: charA.prompt_tokens?.character_en || cast.speaker_A.character_en,
        face_anchor: anchorA.face_silhouette || 'distinctive face',
        signature: anchorA.signature_element || 'notable accessory',
        skin_detail: cast.speaker_A.skin,
        eyes_detail: cast.speaker_A.eyes,
        mouth_detail: 'mouth open mid-word, realistic teeth/gums visible, lip moisture, micro saliva glint on lower lip',
        expression: `mid-sentence ${charA.speech_pace === 'fast' ? 'animated, rapid gesticulation, eyes wide with righteous energy' : charA.speech_pace === 'slow' ? 'intense, measured fury, narrowed eyes burning with controlled outrage' : 'passionate, eyebrows raised in indignation'}, ${anchorA.micro_gesture || 'expressive gesture'}, direct intense eye contact with lens, nostrils slightly flared`,
        body: `${charA.compatibility === 'chaotic' ? 'leaning forward aggressively, both hands gesturing wildly, shoulders tense, invading camera space' : charA.compatibility === 'calm' ? 'upright posture with one hand gesturing precisely, controlled power stance, finger pointing for emphasis' : 'leaning forward, one hand gesturing emphatically (fingers naturally curled, anatomically correct), shoulders tense and raised'}`,
        wardrobe: wardrobeA,
        spatial: 'positioned left of frame, body angled 30¬∞ toward B',
      },
      {
        role: 'B ‚Äî punchline (listening, silent)',
        appearance: charB.prompt_tokens?.character_en || cast.speaker_B.character_en,
        face_anchor: anchorB.face_silhouette || 'distinctive face',
        signature: anchorB.signature_element || 'notable accessory',
        skin_detail: cast.speaker_B.skin,
        eyes_detail: cast.speaker_B.eyes,
        mouth_detail: 'mouth FIRMLY SEALED, jaw still, lips pressed together, slight contemptuous curl at corner',
        expression: `${charB.compatibility === 'calm' ? 'zen-like stillness, barely contained superiority' : charB.compatibility === 'chaotic' ? 'simmering barely-restrained energy, jaw tight, eyes burning' : charB.compatibility === 'conflict' ? 'cold calculating stare, measuring every word A says' : 'amused skepticism, one corner of mouth fighting a smirk'}, ${anchorB.micro_gesture || 'raised eyebrow'}, eyes tracking A with ${charB.speech_pace === 'slow' ? 'patient devastating certainty' : 'sharp analytical intensity'}, one eyebrow 2mm higher than the other`,
        body: `${charB.compatibility === 'calm' ? 'perfectly still, arms loosely crossed, weight centered, radiating quiet authority' : charB.compatibility === 'chaotic' ? 'restless energy contained in stillness, fingers tapping on crossed arms, weight shifting' : 'arms crossed or hands on hips, leaning back slightly, weight on back foot, chin slightly raised'}`,
        wardrobe: wardrobeB,
        spatial: 'positioned right of frame, body angled 30¬∞ toward A',
      },
    ],
    environment: {
      location,
      lighting: `${lightingMood.style}, soft fill from environment bounce, realistic shadow under nose and cheekbones`,
      lighting_mood: lightingMood.mood,
      prop_anchor: `${propAnchor} visible in mid-ground, slightly out of focus`,
      props: ['worn textured surface beneath characters', propAnchor, 'ambient domestic detail in soft bokeh background', 'natural clutter appropriate to location'],
      atmosphere: `lived-in, authentic, slightly chaotic. Category vibe: ${cat.en.toLowerCase()}`,
    },
    camera: {
      angle: 'slightly below eye level (5-10¬∞), selfie POV at arm\'s length, device INVISIBLE',
      distance: 'close enough to read skin microtexture and pore detail, both faces fully in frame',
      lens: '24mm equivalent, f/2.0, shallow DOF ‚Äî faces sharp, background 20-30% bokeh',
      focus: 'critical focus on eyes of speaking character (A), B in acceptable focus, background soft',
      composition: 'loose rule-of-thirds, A occupies left third, B right third, slight headroom, intimate framing',
      realism: cameraPreset.realism_anchors.join(', '),
    },
    color_mood: lightingMood.mood === 'nostalgic warmth'
      ? 'warm amber undertone, golden highlights, slightly desaturated shadows, natural skin tones, subtle teal in shadows for cinematic contrast'
      : lightingMood.mood === 'sterile tension'
      ? 'cool desaturated palette, greenish midtones from fluorescent, pale skin rendering, muted colors, clinical contrast'
      : lightingMood.mood === 'organic chaos'
      ? 'dappled warm-cool mix, green-gold foliage reflections on skin, natural vibrant saturation, earthy tones'
      : lightingMood.mood === 'dramatic intimacy'
      ? 'high-contrast chiaroscuro, deep amber in highlights, rich black shadows, warm skin tones with cool shadow edges'
      : 'soft neutral palette, slight blue undertone, gentle contrast, natural skin tones with minimal color cast',
    hands_instruction: 'CRITICAL: All hands must have exactly 5 fingers, anatomically correct proportions, natural nail detail, age-appropriate skin texture on hands matching face',
    style: 'photorealistic, cinematic grain (ISO 800-1600 feel), raw authentic feel, no filters, no beauty mode, skin imperfections VISIBLE and CELEBRATED',
    negative: 'no text, no watermark, no logo, no phone visible, no camera visible, no overlay, no cartoon, no anime, no plastic skin, no airbrushed look, no 6th finger, no extra limbs, no symmetrical twins, no stock photo feel, no studio lighting',
    ...(product_info?.description_en ? {
      product_placement: {
        instruction: 'CRITICAL: One character MUST be holding or interacting with the product described below. The product must appear EXACTLY as described ‚Äî same shape, colors, branding, materials. It is the focal point of their argument.',
        product_description: product_info.description_en,
        placement: 'Character A holds the product while arguing, product clearly visible in frame, photorealistic rendering matching original reference photo',
      }
    } : {}),
  };

  // ‚îÄ‚îÄ VIDEO PROMPT (EN) ‚îÄ‚îÄ
  const video_prompt_en_json = {
    cast,
    identity_anchors: {
      A: { silhouette: anchorA.face_silhouette, element: anchorA.signature_element, gesture: anchorA.micro_gesture, wardrobe: wardrobeA },
      B: { silhouette: anchorB.face_silhouette, element: anchorB.signature_element, gesture: anchorB.micro_gesture, wardrobe: wardrobeB },
      serial: { aesthetic, prop_anchor: propAnchor },
    },
    ...(topicEn ? { topic_context: topicEn } : {}),
    ...(sceneHint ? { scene_reference: `Visual/structural reference from source video: "${sceneHint}". Adapt the energy and pacing but keep original characters and dialogue.` } : {}),
    dialogue: {
      line_A_ru: dialogueA,
      line_B_ru: dialogueB,
      killer_word: killerWord,
      language: 'Russian (spoken naturally with regional intonation)',
      lip_sync: 'CRITICAL: mouth movements must match Russian phonemes precisely. Each syllable produces visible jaw/lip movement. Consonants: visible tongue/teeth contact. Vowels: proportional mouth opening.',
      delivery_A: `${charA.speech_pace} pace, ${charA.vibe_archetype || 'provocative'} energy, ${charA.swear_level > 1 ? 'occasional expressive profanity as accent' : 'controlled passionate delivery'}`,
      voice_timbre_A: `${charA.speech_pace === 'fast' ? 'high-energy, slightly shrill when agitated, voice cracks on emphasis words' : charA.speech_pace === 'slow' ? 'deep gravelly rasp, deliberate enunciation, resonant chest voice' : 'mid-range natural voice, rises in pitch with indignation'}. Age-appropriate ${cast.speaker_A.age} voice ‚Äî ${charA.swear_level > 1 ? 'rough edges, lived-in vocal texture, hoarse undertone' : 'clear but weathered, slight tremor on emotional peaks'}`,
      delivery_B: `${charB.speech_pace} pace, ${charB.vibe_archetype || 'grounded'} energy, measured buildup to killer word, voice drops for contrast`,
      voice_timbre_B: `${charB.speech_pace === 'slow' ? 'low deliberate rumble, pauses filled with audible nose-exhale, words land like stones' : charB.speech_pace === 'fast' ? 'sharp staccato delivery, clipped consonants, rapid-fire with sudden stops for effect' : 'steady measured mid-tone, controlled volume that drops to near-whisper on killer word for devastating contrast'}. Age-appropriate ${cast.speaker_B.age} voice ‚Äî worn but commanding`,
    },
    spatial: {
      positioning: 'Both characters face camera at arm\'s length distance (selfie POV). A on left, B on right. They stand/sit shoulder-to-shoulder or slightly angled toward each other (30¬∞). Close enough to touch but not touching.',
      camera_movement: 'Handheld micro-jitter throughout. Hook: slight camera push-in. Act_A: subtle drift toward A. Act_B: micro-pan to B. Release: camera shakes from laughter tremor.',
      environment_interaction: `Characters naturally inhabit ${location.split(',')[0]}. Ambient environment detail reinforces ${cat.en.toLowerCase()} theme.`,
    },
    emotion_arc: {
      hook: `tension spike ‚Äî ${hookObj.action_en}, ${charA.vibe_archetype || 'provocateur'} initiates with signature energy`,
      act_A: `escalation ‚Äî ${charA.name_ru} builds ${charA.speech_pace === 'fast' ? 'rapid-fire righteous indignation, words tumbling out' : charA.speech_pace === 'slow' ? 'deliberate simmering outrage, each word weighted' : 'rising passionate indignation'}. ${charB.name_ru} simmers: ${charB.modifiers?.laugh_style === 'grudging smirk' ? 'jaw locked, one eyebrow rising in disbelief' : 'stone-faced, micro-reactions in eyes only'}`,
      act_B: `reversal ‚Äî ${charB.name_ru} delivers ${charB.speech_pace === 'slow' ? 'devastatingly measured response, pauses as weapons' : charB.speech_pace === 'fast' ? 'rapid comeback that builds to the kill shot' : 'controlled response building to killer word'}. "${killerWord}" lands with visible physical impact on ${charA.name_ru}. ${charA.name_ru} freezes mid-gesture.`,
      release: `catharsis ‚Äî ${releaseObj.action_ru}. Tension dissolves into warmth. ${charA.modifiers?.laugh_style || 'genuine laughter'} from A, ${charB.modifiers?.laugh_style || 'satisfied chuckle'} from B.`,
    },
    vibe: {
      dynamic: `${charA.name_ru} (A, ${charA.vibe_archetype || '–ø—Ä–æ–≤–æ–∫–∞—Ç–æ—Ä'}) ‚Üí ${charB.name_ru} (B, ${charB.vibe_archetype || '–±–∞–∑–∞'})`,
      hook: hookObj.action_en,
      conflict: `Comedic tension about ${cat.en.toLowerCase()}${topicRu ? ': ' + topicRu : ''}, no personal insults, rage directed at situation only`,
      punchline: `Killer word "${killerWord}" lands near 7.0s mark, followed by ${releaseObj.action_en}`,
      tone: `${charA.compatibility === 'chaotic' || charB.compatibility === 'chaotic' ? 'Explosive chaotic energy ‚Äî physical comedy, big gestures, near-slapstick' : charA.compatibility === 'calm' || charB.compatibility === 'calm' ? 'Slow-burn tension ‚Äî understated delivery, power in restraint, devastating quiet punchline' : 'Balanced push-pull ‚Äî both characters committed, natural escalation to punchline'}`,
    },
    camera: cameraPreset,
    world: {
      location,
      lighting: `${lightingMood.style}, no studio lighting`,
      lighting_mood: lightingMood.mood,
      wardrobe_A: wardrobeA,
      wardrobe_B: wardrobeB,
      prop_anchor: `${propAnchor} ‚Äî visible in scene, may be interacted with during hook`,
    },
    timing: timingGrid,
    audio: {
      room_tone: location.includes('kitchen') || location.includes('fridge')
        ? 'humming Saratov fridge compressor cycle, wall clock tick, distant plumbing gurgle, occasional window draft whistle'
        : location.includes('garden') || location.includes('greenhouse') || location.includes('sunflower')
        ? 'bird song (sparrows, distant cuckoo), wind through foliage, buzzing insects, soil crunch underfoot'
        : location.includes('balcony') || location.includes('laundry')
        ? 'distant city hum, car horns at irregular intervals, pigeon cooing, clothesline wire creak in wind'
        : location.includes('stairwell') || location.includes('mailbox')
        ? 'fluorescent tube buzz, distant elevator machinery, muffled TV through walls, echo in concrete space'
        : location.includes('bazaar') || location.includes('watermelon')
        ? 'crowd murmur, vendor calls, plastic bag rustle, metal scale clank, distant radio music'
        : location.includes('polyclinic') || location.includes('mint-green')
        ? 'fluorescent hum, rubber shoe squeaks on linoleum, distant intercom PA, muffled coughing behind doors'
        : location.includes('Marshrutka') || location.includes('vinyl')
        ? 'diesel engine vibration, vinyl seat squeak, hanging air freshener sway, muffled traffic outside, door pneumatics hiss'
        : location.includes('barn') || location.includes('hay')
        ? 'creaking wood, wind through plank gaps, distant animal sounds, swinging lightbulb chain clink'
        : location.includes('attic') || location.includes('rafter')
        ? 'roof rain patter or wind howl, creaking rafters, moth flutter, dust settling whisper'
        : 'subtle ambient room sound ‚Äî quiet hum, occasional creak, authentic space acoustics matching location',
      cloth_rustle: `on every major body movement: A wears ${wardrobeA.split(',')[0]} ‚Äî ${wardrobeA.includes('silk') || wardrobeA.includes('chiffon') ? 'soft whisper swish' : wardrobeA.includes('leather') ? 'stiff leather creak' : wardrobeA.includes('knit') || wardrobeA.includes('mohair') || wardrobeA.includes('wool') ? 'soft fibrous drag' : 'medium fabric rustle'}; B wears ${wardrobeB.split(',')[0]} ‚Äî ${wardrobeB.includes('telnyashka') || wardrobeB.includes('cotton') ? 'cotton stretch snap' : wardrobeB.includes('corduroy') ? 'corduroy ridge whisper' : wardrobeB.includes('quilted') || wardrobeB.includes('fufaika') ? 'padded fabric thump' : 'natural fabric rustle'}`,
      saliva_clicks: 'subtle mouth sounds on hard consonants (—Ç, –∫, –ø, –¥)',
      breathing: 'audible inhale before each speaking turn, exhale on emphasis words',
      overlap_policy: 'STRICTLY FORBIDDEN. Gap 0.15-0.25s silence stitch between speakers. No simultaneous speech ever.',
      mouth_rule: 'Non-speaking character: sealed lips, jaw completely still, NO micro-movements of mouth. Eye tracking and subtle facial micro-expressions ONLY.',
      laugh: 'louder than dialogue peak by 20-30%, no digital clipping, raspy and contagious, bodies visibly shaking',
      foley: 'table/surface impacts if hook involves slap, object rattle on impact, fabric whoosh on dramatic gesture',
    },
    safety: {
      banned_words_replaced: true,
      device_invisible: true,
      no_overlays: true,
      no_text_in_frame: true,
      content_type: 'satirical/domestic',
      hands: 'exactly 5 fingers per hand at all times, anatomically correct',
    },
    output: { format: 'mp4 h264', resolution: '1080x1920 vertical 9:16', fps: 30, duration: '8.0s ¬±0.2s', color: 'rec709, natural grade, no LUT' },
    ...(product_info?.description_en ? {
      product_placement: {
        instruction: 'CRITICAL: The product described below MUST appear in the video. Character A holds/shows it during their line. The product must be rendered with photorealistic accuracy matching the original reference photo exactly ‚Äî same colors, shape, branding, materials, proportions.',
        product_description: product_info.description_en,
        integration: 'Product is naturally woven into the comedic argument. A uses it as a prop during provocation. Product stays visible throughout acts A and B.',
      }
    } : {}),
  };

  // ‚îÄ‚îÄ ENGAGEMENT (smart hashtags + viral bait) ‚îÄ‚îÄ
  const engage = buildEngagement(cat.ru, charA, charB, rng);

  // ‚îÄ‚îÄ RU PACKAGE ‚îÄ‚îÄ
  const hashMem = thread_memory ? (typeof btoa !== 'undefined' ? btoa(unescape(encodeURIComponent(thread_memory))).slice(0, 8) : 'mem') : 'none';
  // ‚îÄ‚îÄ Pair dynamic label ‚îÄ‚îÄ
  const pairDynamic = charA.compatibility === 'chaotic' && charB.compatibility === 'calm' ? 'üî• –í–∑—Ä—ã–≤–Ω–∞—è –ø–∞—Ä–∞: —Ö–∞–æ—Å vs —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ'
    : charA.compatibility === 'chaotic' || charB.compatibility === 'chaotic' ? 'üå™ –•–∞–æ—Ç–∏—á–Ω–∞—è –ø–∞—Ä–∞'
    : charA.compatibility === 'conflict' || charB.compatibility === 'conflict' ? '‚ö° –ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–∞—è –ø–∞—Ä–∞'
    : charA.compatibility === 'meme' && charB.compatibility === 'meme' ? 'üòÇ –ú–µ–º-–ø–∞—Ä–∞'
    : '‚öñÔ∏è –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞—Ä–∞';

  const ru_package = `üé¨ –î–ò–ê–õ–û–ì –° –¢–ê–ô–ú–ò–ù–ì–ê–ú–ò (v2 Production Contract)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${cat.ru}${topicRu ? `\nüí° –ò–¥–µ—è: ${topicRu}` : ''}${sceneHint ? `\nüé• –†–µ—Ñ–µ—Ä–µ–Ω—Å: ${sceneHint}` : ''}
ÔøΩ –ü–∞—Ä–∞: ${charA.name_ru} (${cast.speaker_A.age}) √ó ${charB.name_ru} (${cast.speaker_B.age})
üé≠ –î–∏–Ω–∞–º–∏–∫–∞: ${pairDynamic}
ÔøΩÔøΩ –õ–æ–∫–∞—Ü–∏—è: ${location.split(',')[0]}
üí° –û—Å–≤–µ—â–µ–Ω–∏–µ: ${lightingMood.mood}
üëó A: ${wardrobeA}
üëî B: ${wardrobeB}
ü™ë –†–µ–∫–≤–∏–∑–∏—Ç: ${propAnchor}

[0.00‚Äì0.80] üé£ –•–£–ö: ${hookObj.action_ru}
  üîä –ó–≤—É–∫: ${hookObj.audio}
  üé≠ –°—Ç–∏–ª—å —Ö—É–∫–∞ A: ${charA.modifiers?.hook_style || '–≤–Ω–∏–º–∞–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ'}

[0.80‚Äì3.60] üÖ∞Ô∏è ${charA.name_ru} (${charA.vibe_archetype || '—Ä–æ–ª—å A'}):
  ¬´${dialogueA}¬ª
  üí¨ –¢–µ–º–ø: ${charA.speech_pace} | –°–ª–æ–≤: 6-9 | ${charA.swear_level > 0 ? '–º–∞—Ç –∫–∞–∫ –∞–∫—Ü–µ–Ω—Ç' : '–±–µ–∑ –º–∞—Ç–∞'}
  üó£ –ì–æ–ª–æ—Å: ${charA.speech_pace === 'fast' ? '–±—ã—Å—Ç—Ä—ã–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å –Ω–∞–¥—Ä—ã–≤–æ–º' : charA.speech_pace === 'slow' ? '–Ω–∏–∑–∫–∏–π, —Ç—è–∂—ë–ª—ã–π, –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –≤–µ—Å–æ–º' : '—Å—Ä–µ–¥–Ω–∏–π —Ç–µ–º–±—Ä, –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∞—è –∏–Ω–¥ign–∞—Ü–∏—è'}
  üé≠ –ú–∏–∫—Ä–æ–∂–µ—Å—Ç: ${anchorA.micro_gesture || charA.modifiers?.hook_style || '–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π –∂–µ—Å—Ç'}
  üëÑ –†–æ—Ç B: –≥—É–±—ã —Å–æ–º–∫–Ω—É—Ç—ã, —á–µ–ª—é—Å—Ç—å –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–∞, –≥–ª–∞–∑–∞ —Å–ª–µ–¥—è—Ç –∑–∞ A

[3.60‚Äì7.10] üÖ±Ô∏è ${charB.name_ru} (${charB.vibe_archetype || '—Ä–æ–ª—å B'}):
  ¬´${dialogueB}¬ª
  üí¨ –¢–µ–º–ø: ${charB.speech_pace} | –°–ª–æ–≤: 6-11 | –ø–∞—É–∑—ã = —Å–∏–ª–∞
  üó£ –ì–æ–ª–æ—Å: ${charB.speech_pace === 'slow' ? '–Ω–∏–∑–∫–∏–π, —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–π, —Å–ª–æ–≤–∞ –∫–∞–∫ –∫–∞–º–Ω–∏' : charB.speech_pace === 'fast' ? '—Å—Ç–∞–∫–∫–∞—Ç–æ, –æ—Ç—Ä—ã–≤–∏—Å—Ç—ã–π, —Ä–µ–∑–∫–∏–µ –ø–∞—É–∑—ã' : '–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π, –Ω–∞ killer word –≥–æ–ª–æ—Å –ø–∞–¥–∞–µ—Ç –¥–æ —à—ë–ø–æ—Ç–∞'}
  üí• KILLER WORD ¬´${killerWord}¬ª ‚Üí –±–ª–∏–∂–µ –∫ 7.0s
  üëÑ –†–æ—Ç A: –∑–∞–º–µ—Ä–ª–∞ –≤ –ø–æ–∑–µ, —Ä–æ—Ç –∑–∞–∫—Ä—ã—Ç, –ª–∏—Ü–æ –≤ —à–æ–∫–µ

[7.10‚Äì8.00] üòÇ RELEASE: ${releaseObj.action_ru}
  üîä –°–º–µ—Ö –≥—Ä–æ–º—á–µ —Ä–µ–ø–ª–∏–∫ –Ω–∞ 20-30%, –±–µ–∑ –∫–ª–∏–ø–ø–∏–Ω–≥–∞, —Ç–µ–ª–∞ —Ç—Ä—è—Å—É—Ç—Å—è
  üé≠ –°–º–µ—Ö A: ${charA.modifiers?.laugh_style || '–∏—Å–∫—Ä–µ–Ω–Ω–∏–π —Å–º–µ—Ö'}
  üé≠ –°–º–µ—Ö B: ${charB.modifiers?.laugh_style || '–¥–æ–≤–æ–ª—å–Ω—ã–π —Å–º–µ—à–æ–∫'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì± –ó–ê–ì–û–õ–û–í–û–ö (–∫–æ–ø–∏—Ä—É–π –∫–∞–∫ –µ—Å—Ç—å):
${engage.viralTitle}

üìå –ó–ê–ö–†–ï–ü (–ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç –æ—Ç –∞–≤—Ç–æ—Ä–∞):
${engage.pinComment}

üí¨ –ü–ï–†–í–´–ô –ö–û–ú–ú–ï–ù–¢ (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏):
${engage.firstComment}

#Ô∏è‚É£ –•–≠–®–¢–ï–ì–ò (${engage.hashtags.length} —à—Ç ‚Äî –≤—Å—Ç–∞–≤–ª—è—Ç—å –í –ü–ï–†–í–´–ô –ö–û–ú–ú–ï–ù–¢, –Ω–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ):
${engage.hashtags.join(' ')}

üí° –°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –≤ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ (caption). –¢–æ—á–∫–∞. –ë–µ–∑ —Ö–µ—à—Ç–µ–≥–æ–≤.
‚Ä¢ –•–µ—à—Ç–µ–≥–∏ ‚Üí –≤ –ü–ï–†–í–´–ô –∫–æ–º–º–µ–Ω—Ç –æ—Ç –∞–≤—Ç–æ—Ä–∞ (IG –Ω–µ —Ä–µ–∂–µ—Ç –æ—Ö–≤–∞—Ç).
‚Ä¢ –ó–∞–∫—Ä–µ–ø ‚Üí –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É.
‚Ä¢ –ü–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç ‚Üí –ø–æ—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
‚Ä¢ –°–µ—Ä–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π ${engage.seriesTag} –Ω–∞ –∫–∞–∂–¥–æ–º –≤–∏–¥–µ–æ —ç—Ç–æ–π –ø–∞—Ä—ã.${product_info?.description_en ? `

üì¶ –¢–û–í–ê–† –í –ö–ê–î–†–ï:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (EN, –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞): ${product_info.description_en.slice(0, 300)}${product_info.description_en.length > 300 ? '...' : ''}

‚ö†Ô∏è –í–ê–ñ–ù–û: –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–∞–¥—Ä–µ —Ç–æ—á–Ω–æ –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–æ—Ç–æ!
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–∂ A –¥–µ—Ä–∂–∏—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä –≤–æ –≤—Ä–µ–º—è —Å–≤–æ–µ–π —Ä–µ–ø–ª–∏–∫–∏
‚Ä¢ –¢–æ–≤–∞—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º—ã–º –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ —Ä–æ–ª–∏–∫–∞
‚Ä¢ –¶–≤–µ—Ç–∞, —Ñ–æ—Ä–º–∞, –±—Ä–µ–Ω–¥ ‚Äî —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–æ—Ç–æ` : ''}`;

  // ‚îÄ‚îÄ BLUEPRINT JSON ‚îÄ‚îÄ
  const blueprint_json = {
    version: '2.0',
    ...(topicRu ? { topic_ru: topicRu } : {}),
    ...(topicEn ? { topic_en: topicEn } : {}),
    ...(sceneHint ? { scene_reference: sceneHint } : {}),
    category: cat,
    lighting: lightingMood,
    scenes: [
      { id: 1, segment: 'hook', action: hookObj.action_en, speaker: 'A', start: GRID_V2.hook.start, end: GRID_V2.hook.end, dialogue_ru: '', speech_hints: `${hookObj.audio}, ${charA.modifiers?.hook_style || 'attention grab'}` },
      { id: 2, segment: 'act_A', action: `${charA.vibe_archetype || 'Provocateur'} delivers ${charA.speech_pace === 'fast' ? 'rapid-fire indignation' : charA.speech_pace === 'slow' ? 'slow-burn provocation' : 'passionate provocation'}`, speaker: 'A', start: GRID_V2.act_A.start, end: GRID_V2.act_A.end, dialogue_ru: dialogueA, speech_hints: `${charA.speech_pace} pace, 6-9 words, ${charA.swear_level > 1 ? 'expressive accent' : 'controlled'}, B sealed, ${anchorA.micro_gesture || 'emphatic gestures'}` },
      { id: 3, segment: 'act_B', action: `${charB.vibe_archetype || 'Grounded responder'} delivers ${charB.speech_pace === 'slow' ? 'devastating measured punchline' : charB.speech_pace === 'fast' ? 'rapid-fire killer response' : 'controlled punchline buildup'}`, speaker: 'B', start: GRID_V2.act_B.start, end: GRID_V2.act_B.end, dialogue_ru: dialogueB, speech_hints: `${charB.speech_pace} pace, 6-11 words, killer word "${killerWord}" near end, A frozen, ${anchorB.micro_gesture || 'subtle gesture on punchline'}` },
      { id: 4, segment: 'release', action: releaseObj.action_en, speaker: 'both', start: GRID_V2.release.start, end: GRID_V2.release.end, dialogue_ru: '', speech_hints: `zero words, ${charB.modifiers?.laugh_style || 'natural laugh'}, shared laugh` },
    ],
    dialogue_segments: [
      { speaker: 'A', text_ru: dialogueA, start: GRID_V2.act_A.start, end: GRID_V2.act_A.end, word_range: '6-9' },
      { speaker: 'B', text_ru: dialogueB, start: GRID_V2.act_B.start, end: GRID_V2.act_B.end, word_range: '6-11' },
    ],
    timing_grid: {
      total: 8.0,
      hook: [GRID_V2.hook.start, GRID_V2.hook.end],
      A: [GRID_V2.act_A.start, GRID_V2.act_A.end],
      B: [GRID_V2.act_B.start, GRID_V2.act_B.end],
      release: [GRID_V2.release.start, GRID_V2.release.end],
      killer_word_at: 6.85,
      gap_between_speakers: '0.15-0.25s',
    },
    identity_anchors: {
      A: charA.identity_anchors || {},
      B: charB.identity_anchors || {},
    },
    cast_summary: {
      A: { name: charA.name_ru, age: cast.speaker_A.age, vibe: charA.vibe_archetype, pace: charA.speech_pace, compatibility: charA.compatibility },
      B: { name: charB.name_ru, age: cast.speaker_B.age, vibe: charB.vibe_archetype, pace: charB.speech_pace, compatibility: charB.compatibility },
      pair_dynamic: pairDynamic,
    },
  };

  // ‚îÄ‚îÄ QC Gate ‚îÄ‚îÄ
  const qc = runQCGate(blueprint_json, cast);

  // ‚îÄ‚îÄ Validate ‚îÄ‚îÄ
  const output = { photo_prompt_en_json, video_prompt_en_json, ru_package, blueprint_json };
  const validation = runAllValidations(output, historyCache);

  // ‚îÄ‚îÄ Update history ‚îÄ‚îÄ
  historyCache.addGeneration({
    location,
    props: [propAnchor],
    wardrobeA,
    wardrobeB,
    category: cat.ru,
  });

  const log = {
    seed,
    generator_version: '2.0',
    memory_hash: hashMem,
    characters: [charA.id, charB.id],
    vibes: [charA.vibe_archetype, charB.vibe_archetype],
    category: cat,
    engagement: {
      viral_title: engage.viralTitle,
      pin_comment: engage.pinComment,
      first_comment: engage.firstComment,
      series_tag: engage.seriesTag,
      hashtag_count: engage.hashtags.length,
      hashtags: engage.hashtags,
    },
    qc_gate: { passed: qc.passed, total: qc.total, ok: qc.ok, hard_fails: qc.hard_fails },
    warnings: validation.warnings,
    auto_fixes: autoFixes,
    duration_estimate: estimate.total,
    input_mode,
    timestamp: new Date().toISOString(),
  };

  return {
    photo_prompt_en_json,
    video_prompt_en_json,
    ru_package,
    blueprint_json,
    log,
    warnings: [...validation.warnings, ...(qc.ok ? [] : [`QC Gate: ${qc.passed}/${qc.total} (need ‚â•9)${qc.hard_fails.length ? ', HARD FAIL: ' + qc.hard_fails.join(', ') : ''}`])],
    auto_fixes: [...autoFixes, ...validation.auto_fixes],
    duration_estimate: estimate,
    qc_gate: qc,
    // Context for API mode ‚Äî sent to server for Gemini refinement
    _apiContext: {
      charA, charB, category: cat, topic_ru: topicRu, scene_hint: sceneHint,
      input_mode, video_meta, product_info, location, wardrobeA, wardrobeB,
      propAnchor, lightingMood, hookAction: hookObj, releaseAction: releaseObj,
      aesthetic, script_ru,
    },
  };
}

// ‚îÄ‚îÄ‚îÄ MERGE GEMINI RESULT INTO LOCAL TEMPLATE ‚îÄ‚îÄ
// Takes local generation (structural) + Gemini output (creative) ‚Üí merged result
export function mergeGeminiResult(localResult, geminiData) {
  if (!geminiData) return localResult;

  const ctx = localResult._apiContext;
  const g = geminiData;

  // Deep clone to avoid mutating original
  const r = JSON.parse(JSON.stringify(localResult));

  // ‚îÄ‚îÄ 1. Photo prompt: replace scene with Gemini's ultra-detailed version ‚îÄ‚îÄ
  if (g.photo_scene_en) {
    r.photo_prompt_en_json.scene = g.photo_scene_en;
  }

  // ‚îÄ‚îÄ 2. Video prompt: replace dialogue ‚îÄ‚îÄ
  if (g.dialogue_A_ru) r.video_prompt_en_json.dialogue.line_A_ru = g.dialogue_A_ru;
  if (g.dialogue_B_ru) r.video_prompt_en_json.dialogue.line_B_ru = g.dialogue_B_ru;
  if (g.killer_word) r.video_prompt_en_json.dialogue.killer_word = g.killer_word;

  // ‚îÄ‚îÄ 3. Video prompt: replace emotion arc ‚îÄ‚îÄ
  if (g.video_emotion_arc) {
    const arc = g.video_emotion_arc;
    r.video_prompt_en_json.emotion_arc = {
      hook: arc.hook_en || r.video_prompt_en_json.emotion_arc.hook,
      act_A: arc.act_A_en || r.video_prompt_en_json.emotion_arc.act_A,
      act_B: arc.act_B_en || r.video_prompt_en_json.emotion_arc.act_B,
      release: arc.release_en || r.video_prompt_en_json.emotion_arc.release,
    };
  }

  // ‚îÄ‚îÄ 4. Video prompt: replace atmosphere ‚îÄ‚îÄ
  if (g.video_atmosphere_en) {
    r.video_prompt_en_json.spatial.environment_interaction = g.video_atmosphere_en;
  }

  // ‚îÄ‚îÄ 5. Blueprint: replace dialogue in scenes ‚îÄ‚îÄ
  if (g.dialogue_A_ru) {
    if (r.blueprint_json.scenes[1]) r.blueprint_json.scenes[1].dialogue_ru = g.dialogue_A_ru;
    if (r.blueprint_json.dialogue_segments[0]) r.blueprint_json.dialogue_segments[0].text_ru = g.dialogue_A_ru;
  }
  if (g.dialogue_B_ru) {
    if (r.blueprint_json.scenes[2]) r.blueprint_json.scenes[2].dialogue_ru = g.dialogue_B_ru;
    if (r.blueprint_json.dialogue_segments[1]) r.blueprint_json.dialogue_segments[1].text_ru = g.dialogue_B_ru;
  }

  // ‚îÄ‚îÄ 6. Rebuild RU package with Gemini's creative content ‚îÄ‚îÄ
  const dA = g.dialogue_A_ru || ctx.dialogueA || '‚Äî';
  const dB = g.dialogue_B_ru || ctx.dialogueB || '‚Äî';
  const kw = g.killer_word || '‚Äî';
  const charA = ctx.charA;
  const charB = ctx.charB;
  const cast = r.video_prompt_en_json.cast || {};
  const anchorA = charA.identity_anchors || {};
  const anchorB = charB.identity_anchors || {};

  const pairDynamic = charA.compatibility === 'chaotic' && charB.compatibility === 'calm' ? 'üî• –í–∑—Ä—ã–≤–Ω–∞—è –ø–∞—Ä–∞: —Ö–∞–æ—Å vs —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ'
    : charA.compatibility === 'chaotic' || charB.compatibility === 'chaotic' ? 'üå™ –•–∞–æ—Ç–∏—á–Ω–∞—è –ø–∞—Ä–∞'
    : charA.compatibility === 'conflict' || charB.compatibility === 'conflict' ? '‚ö° –ö–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–∞—è –ø–∞—Ä–∞'
    : charA.compatibility === 'meme' && charB.compatibility === 'meme' ? 'üòÇ –ú–µ–º-–ø–∞—Ä–∞'
    : '‚öñÔ∏è –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞—Ä–∞';

  // Engagement from Gemini
  const viralTitle = g.viral_title_ru || r.log?.engagement?.viral_title || '';
  const pinComment = g.pin_comment_ru || r.log?.engagement?.pin_comment || '';
  const firstComment = g.first_comment_ru || r.log?.engagement?.first_comment || '';
  const hashtags = (g.hashtags || r.log?.engagement?.hashtags || []).map(t => t.startsWith('#') ? t : '#' + t);
  const seriesTag = '#' + (charA.name_ru || '').replace(/\s+/g, '').toLowerCase() + 'vs' + (charB.name_ru || '').replace(/\s+/g, '').toLowerCase();

  r.ru_package = `üé¨ –î–ò–ê–õ–û–ì –° –¢–ê–ô–ú–ò–ù–ì–ê–ú–ò (v2 Gemini Production)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${ctx.category.ru}${ctx.topic_ru ? `\nüí° –ò–¥–µ—è: ${ctx.topic_ru}` : ''}${ctx.scene_hint ? `\nüé• –†–µ—Ñ–µ—Ä–µ–Ω—Å: ${ctx.scene_hint}` : ''}
ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ Gemini ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
üë• –ü–∞—Ä–∞: ${charA.name_ru} (${cast.speaker_A?.age || 'elderly'}) √ó ${charB.name_ru} (${cast.speaker_B?.age || 'elderly'})
üé≠ –î–∏–Ω–∞–º–∏–∫–∞: ${pairDynamic}
üìç –õ–æ–∫–∞—Ü–∏—è: ${ctx.location.split(',')[0]}
üí° –û—Å–≤–µ—â–µ–Ω–∏–µ: ${ctx.lightingMood.mood}
üëó A: ${ctx.wardrobeA}
üëî B: ${ctx.wardrobeB}
ü™ë –†–µ–∫–≤–∏–∑–∏—Ç: ${ctx.propAnchor}

[0.00‚Äì0.80] üé£ –•–£–ö: ${ctx.hookAction.action_ru}
  üîä –ó–≤—É–∫: ${ctx.hookAction.audio}
  üé≠ –°—Ç–∏–ª—å —Ö—É–∫–∞ A: ${charA.modifiers?.hook_style || '–≤–Ω–∏–º–∞–Ω–∏–µ –∫ –∫–∞–º–µ—Ä–µ'}

[0.80‚Äì3.60] üÖ∞Ô∏è ${charA.name_ru} (${charA.vibe_archetype || '—Ä–æ–ª—å A'}):
  ¬´${dA}¬ª
  üí¨ –¢–µ–º–ø: ${charA.speech_pace} | ${charA.swear_level > 0 ? '–º–∞—Ç –∫–∞–∫ –∞–∫—Ü–µ–Ω—Ç' : '–±–µ–∑ –º–∞—Ç–∞'}
  üó£ –ì–æ–ª–æ—Å: ${charA.speech_pace === 'fast' ? '–±—ã—Å—Ç—Ä—ã–π, —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å –Ω–∞–¥—Ä—ã–≤–æ–º' : charA.speech_pace === 'slow' ? '–Ω–∏–∑–∫–∏–π, —Ç—è–∂—ë–ª—ã–π, –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Å –≤–µ—Å–æ–º' : '—Å—Ä–µ–¥–Ω–∏–π —Ç–µ–º–±—Ä, –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∞—è –∏–Ω–¥ign–∞—Ü–∏—è'}
  üé≠ –ú–∏–∫—Ä–æ–∂–µ—Å—Ç: ${anchorA.micro_gesture || charA.modifiers?.hook_style || '–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π –∂–µ—Å—Ç'}
  üëÑ –†–æ—Ç B: –≥—É–±—ã —Å–æ–º–∫–Ω—É—Ç—ã, —á–µ–ª—é—Å—Ç—å –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–∞, –≥–ª–∞–∑–∞ —Å–ª–µ–¥—è—Ç –∑–∞ A

[3.60‚Äì7.10] üÖ±Ô∏è ${charB.name_ru} (${charB.vibe_archetype || '—Ä–æ–ª—å B'}):
  ¬´${dB}¬ª
  üí¨ –¢–µ–º–ø: ${charB.speech_pace} | –ø–∞—É–∑—ã = —Å–∏–ª–∞
  üó£ –ì–æ–ª–æ—Å: ${charB.speech_pace === 'slow' ? '–Ω–∏–∑–∫–∏–π, —Ä–∞–∑–º–µ—Ä–µ–Ω–Ω—ã–π, —Å–ª–æ–≤–∞ –∫–∞–∫ –∫–∞–º–Ω–∏' : charB.speech_pace === 'fast' ? '—Å—Ç–∞–∫–∫–∞—Ç–æ, –æ—Ç—Ä—ã–≤–∏—Å—Ç—ã–π, —Ä–µ–∑–∫–∏–µ –ø–∞—É–∑—ã' : '–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π, –Ω–∞ killer word –≥–æ–ª–æ—Å –ø–∞–¥–∞–µ—Ç –¥–æ —à—ë–ø–æ—Ç–∞'}
  üí• KILLER WORD ¬´${kw}¬ª ‚Üí –±–ª–∏–∂–µ –∫ 7.0s
  üëÑ –†–æ—Ç A: –∑–∞–º–µ—Ä–ª–∞ –≤ –ø–æ–∑–µ, —Ä–æ—Ç –∑–∞–∫—Ä—ã—Ç, –ª–∏—Ü–æ –≤ —à–æ–∫–µ

[7.10‚Äì8.00] üòÇ RELEASE: ${ctx.releaseAction.action_ru}
  üîä –°–º–µ—Ö –≥—Ä–æ–º—á–µ —Ä–µ–ø–ª–∏–∫ –Ω–∞ 20-30%, –±–µ–∑ –∫–ª–∏–ø–ø–∏–Ω–≥–∞, —Ç–µ–ª–∞ —Ç—Ä—è—Å—É—Ç—Å—è
  üé≠ –°–º–µ—Ö A: ${charA.modifiers?.laugh_style || '–∏—Å–∫—Ä–µ–Ω–Ω–∏–π —Å–º–µ—Ö'}
  üé≠ –°–º–µ—Ö B: ${charB.modifiers?.laugh_style || '–¥–æ–≤–æ–ª—å–Ω—ã–π —Å–º–µ—à–æ–∫'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üì± –ó–ê–ì–û–õ–û–í–û–ö (–∫–æ–ø–∏—Ä—É–π –∫–∞–∫ –µ—Å—Ç—å):
${viralTitle}

üìå –ó–ê–ö–†–ï–ü (–ø–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç –æ—Ç –∞–≤—Ç–æ—Ä–∞):
${pinComment}

üí¨ –ü–ï–†–í–´–ô –ö–û–ú–ú–ï–ù–¢ (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏):
${firstComment}

#Ô∏è‚É£ –•–≠–®–¢–ï–ì–ò (${hashtags.length} —à—Ç ‚Äî –≤—Å—Ç–∞–≤–ª—è—Ç—å –í –ü–ï–†–í–´–ô –ö–û–ú–ú–ï–ù–¢, –Ω–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–µ):
${hashtags.join(' ')}

üí° –°–¢–†–ê–¢–ï–ì–ò–Ø:
‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚Üí –≤ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ (caption). –¢–æ—á–∫–∞. –ë–µ–∑ —Ö–µ—à—Ç–µ–≥–æ–≤.
‚Ä¢ –•–µ—à—Ç–µ–≥–∏ ‚Üí –≤ –ü–ï–†–í–´–ô –∫–æ–º–º–µ–Ω—Ç –æ—Ç –∞–≤—Ç–æ—Ä–∞ (IG –Ω–µ —Ä–µ–∂–µ—Ç –æ—Ö–≤–∞—Ç).
‚Ä¢ –ó–∞–∫—Ä–µ–ø ‚Üí –∑–∞–∫—Ä–µ–ø–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç —Å–≤–µ—Ä—Ö—É.
‚Ä¢ –ü–µ—Ä–≤—ã–π –∫–æ–º–º–µ–Ω—Ç ‚Üí –ø–æ—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ 1-2 –º–∏–Ω –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.
‚Ä¢ –°–µ—Ä–∏—è: –∏—Å–ø–æ–ª—å–∑—É–π ${seriesTag} –Ω–∞ –∫–∞–∂–¥–æ–º –≤–∏–¥–µ–æ —ç—Ç–æ–π –ø–∞—Ä—ã.${ctx.product_info?.description_en ? `

üì¶ –¢–û–í–ê–† –í –ö–ê–î–†–ï:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (EN, –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞): ${ctx.product_info.description_en.slice(0, 300)}${ctx.product_info.description_en.length > 300 ? '...' : ''}

‚ö†Ô∏è –í–ê–ñ–ù–û: –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫–∞–¥—Ä–µ —Ç–æ—á–Ω–æ –∫–∞–∫ –Ω–∞ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–æ—Ç–æ!
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–∂ A –¥–µ—Ä–∂–∏—Ç/–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä –≤–æ –≤—Ä–µ–º—è —Å–≤–æ–µ–π —Ä–µ–ø–ª–∏–∫–∏
‚Ä¢ –¢–æ–≤–∞—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –≤–∏–¥–∏–º—ã–º –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ —Ä–æ–ª–∏–∫–∞
‚Ä¢ –¶–≤–µ—Ç–∞, —Ñ–æ—Ä–º–∞, –±—Ä–µ–Ω–¥ ‚Äî —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Ñ–æ—Ç–æ` : ''}`;

  // ‚îÄ‚îÄ 7. Update log ‚îÄ‚îÄ
  r.log.generator_version = '2.0-gemini';
  r.log.gemini_model = 'gemini-2.0-flash';
  if (g.viral_title_ru) r.log.engagement.viral_title = g.viral_title_ru;
  if (g.pin_comment_ru) r.log.engagement.pin_comment = g.pin_comment_ru;
  if (g.first_comment_ru) r.log.engagement.first_comment = g.first_comment_ru;
  if (g.hashtags) {
    r.log.engagement.hashtags = hashtags;
    r.log.engagement.hashtag_count = hashtags.length;
  }

  return r;
}
